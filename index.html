<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Schedule Viewer (Final)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- PDF.js (single-page rendering for iOS-safe PDF viewing) -->
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .view-container { display: none; }
        .view-container.active { display: block; }
        
        /* Navigation Buttons */
        .view-toggle-button { transition: all 0.2s; white-space: nowrap; }
        .view-toggle-button.active { background-color: #4f46e5; color: white; border-color: #4f46e5; }
        
        /* Scrollable Selection Lists for Relief View */
        .teacher-select-container { 
            height: 150px; 
            overflow-y: auto; 
            border: 1px solid #d1d5db; 
            border-radius: 0.375rem; 
            padding: 0.25rem; 
            font-size: 0.8rem; 
            background: white; 
        }
        .teacher-select-container label { display: block; padding: 0.2rem 0.4rem; cursor: pointer; }
        .teacher-select-container label:hover { background-color: #f3f4f6; }
        .teacher-select-container input:checked + span { font-weight: 600; color: #4f46e5; }

        /* Status Colors */
        .free-slot { background-color: #d1fae5; color: #065f46; font-weight: 600; font-size: 0.7rem; }
        .unavailable-slot { background-color: #f3f4f6; color: #9ca3af; font-size: 0.7rem; }
        .busy-slot { background-color: #fee2e2; font-size: 0.7rem; }
        
        /* Relief Card Conflicts & Highlights */
        option.conflict-warning { background-color: #fee2e2; color: #b91c1c; font-weight: bold; }
        option.time-conflict { background-color: #991b1b; color: white; font-weight: bold; }
        select.has-conflict { border-color: #ef4444; background-color: #fff5f5; color: #b91c1c; font-weight: 600; }

        /* Highlight for Day Select when teacher is chosen */
        option.highlight-day-option {
            background-color: #dbeafe !important; /* Light Indigo/Blue */
            color: #1e40af !important; /* Dark Indigo/Blue */
            font-weight: 800 !important;
        }

        /* SMART CLASS VIEW: Sticky Table Styles */
        .smart-table-container { 
            position: relative; 
            overflow: auto; 
            max-height: 75vh; 
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }
        .smart-table { border-collapse: separate; border-spacing: 0; width: 100%; }
        
        /* Sticky Headers */
        .smart-table thead th { 
            position: sticky; top: 0; z-index: 20; 
            background-color: #f9fafb; 
            border-bottom: 2px solid #e5e7eb;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        /* Sticky First Column (Days) */
        .smart-table td:first-child, .smart-table th:first-child { 
            position: sticky; left: 0; z-index: 10; 
            background-color: #ffffff; 
            border-right: 2px solid #e5e7eb;
        }
        .smart-table th:first-child { z-index: 30; background-color: #f3f4f6; } 
        
        .current-day-highlight td { background-color: #eef2ff !important; }
        .current-day-highlight td:first-child { border-left: 4px solid #4f46e5; background-color: #e0e7ff !important; }

        /* Empty Slot Pattern */
        .empty-slot-pattern {
            background-image: repeating-linear-gradient(45deg, #f9fafb 25%, transparent 25%, transparent 75%, #f9fafb 75%, #f9fafb), repeating-linear-gradient(45deg, #f9fafb 25%, #f3f4f6 25%, #f3f4f6 75%, #f9fafb 75%, #f9fafb);
            background-position: 0 0, 10px 10px;
            background-size: 20px 20px;
        }

        .class-nav-button { transition: all 0.2s; }
        .class-nav-button.active { background-color: #4338ca; color: white; transform: scale(1.05); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        /* Modal & Loader */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 50; visibility: hidden; opacity: 0; transition: opacity 0.3s; }
        .modal.open { visibility: visible; opacity: 1; }
        .modal-content { background: white; padding: 2rem; border-radius: 0.5rem; width: 95%; max-width: 900px; max-height: 90vh; overflow-y: auto; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #4f46e5; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* FIX: Ensure buttons are tappable */
        button { touch-action: manipulation; }
        
        @media print {
            body { background: white; color: black; font-size: 12px; }
            header, .no-print, #settings-btn, #view-pdf-btn, .view-toggle-button, #view-relief-btn, #view-slot-btn, #view-teacher-btn, #view-class-btn, #view-edit-btn, #loading-indicator, #relief-view > div:first-child, #roster-generation-section, #absent-details-container { display: none !important; }
            #relief-rosters-display { display: block !important; }
            .smart-table-container { overflow: visible; border: none; box-shadow: none; max-height: none; }
            .smart-table td, .smart-table th { position: static !important; border: 1px solid black !important; }
        }
    </style>
</head>
<body class="bg-gray-100 p-2 sm:p-4 md:p-6">

    <div class="max-w-7xl mx-auto bg-white p-4 rounded-lg shadow-lg no-print-container">
        <!-- Main Header -->
        <header class="mb-4 pb-3 border-b flex justify-between items-center no-print">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Unified Schedule Viewer</h1>
                <p id="current-day-display" class="text-indigo-600 font-semibold mt-1"></p>
                <div id="connection-status" class="text-xs font-mono text-gray-400 mt-1 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-gray-400" id="status-dot"></span>
                    <span id="status-text">Initializing...</span>
                </div>
            </div>
            <div class="flex gap-2">
                <!-- PDF View Button -->
                <button id="view-pdf-btn" class="flex items-center gap-1 bg-red-100 text-red-700 hover:bg-red-200 px-3 py-2 rounded-lg transition-colors text-sm font-bold" title="View Reference PDF">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    <span class="hidden sm:inline">View PDF</span>
                </button>
                <!-- Settings Button -->
                <button id="settings-btn" class="p-2 rounded-full text-gray-500 hover:text-indigo-600 hover:bg-gray-100 transition-colors" title="Open Settings">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
            </div>
        </header>
        
        <div id="loading-indicator" class="text-center mt-10 mb-10 no-print">
            <div class="loader"></div>
            <p class="text-sm text-gray-500 mt-4">Connecting to Database...</p>
        </div>

        <!-- Main View Toggler -->
        <div id="main-content" style="display:none;">
            <div class="flex flex-wrap justify-center border-b mb-4 no-print overflow-x-auto pb-2">
                <button id="view-relief-btn" class="view-toggle-button active font-semibold py-2 px-4 text-sm sm:text-base border-b-2 border-transparent hover:bg-gray-50 rounded-t-md">Relief Assignment</button>
                <button id="view-slot-btn" class="view-toggle-button font-semibold py-2 px-4 text-sm sm:text-base border-b-2 border-transparent hover:bg-gray-50 rounded-t-md">Group Availability</button>
                <button id="view-teacher-btn" class="view-toggle-button font-semibold py-2 px-4 text-sm sm:text-base border-b-2 border-transparent hover:bg-gray-50 rounded-t-md">Teacher View</button>
                <button id="view-class-btn" class="view-toggle-button font-semibold py-2 px-4 text-sm sm:text-base border-b-2 border-transparent hover:bg-gray-50 rounded-t-md">Class View</button>
                <button id="view-edit-btn" class="view-toggle-button font-semibold py-2 px-4 text-sm sm:text-base border-b-2 border-transparent hover:bg-indigo-50 text-indigo-700 rounded-t-md">Edit Manager</button>
            </div>

            <!-- RELIEF VIEW (Restored Scroll Layout) -->
            <div id="relief-view" class="view-container active">
                <div class="bg-gray-50 rounded-lg p-3 mb-4 border border-gray-200 no-print">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs">
                        <div class="flex flex-col">
                             <label class="font-bold text-gray-600 mb-1">1. Absent Teacher(s)</label>
                             <input type="text" id="absent-search" placeholder="Filter names..." class="p-1 mb-1 border rounded text-xs">
                             <div id="absent-teacher-multiselect" class="teacher-select-container"></div>
                        </div>
                         <div class="flex flex-col">
                             <label class="font-bold text-gray-600 mb-1">2. Relief Pool</label>
                             <input type="text" id="relief-search" placeholder="Filter names..." class="p-1 mb-1 border rounded text-xs">
                             <div id="replacement-teacher-multiselect" class="teacher-select-container"></div>
                        </div>
                        <div class="flex flex-col justify-between">
                             <div>
                                <label class="font-bold text-gray-600 mb-1">3. Select Day</label>
                                <select id="relief-day-select" class="block w-full p-2 border rounded text-xs mb-2"></select>
                             </div>
                             <button id="find-relief-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded shadow hover:bg-indigo-700 text-xs">Find Replacements</button>
                        </div>
                    </div>
                </div>
                
                <div id="absent-details-container" class="mb-4 no-print hidden"></div>
                
                <!-- GRID FOR CARDS -->
                <div id="relief-results" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 mb-6 no-print"></div>
                
                <div id="roster-generation-section" class="text-center py-4 border-t hidden no-print">
                    <button id="generate-rosters-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded hover:bg-green-700 text-xs shadow-lg">Generate Relief Roster (Printable)</button>
                </div>
                <div id="relief-rosters-display" class="mt-6"></div>
            </div>
            
            <!-- GROUP SLOT VIEW -->
            <div id="slot-view" class="view-container">
                <div class="max-w-3xl mx-auto text-center">
                     <h2 class="text-lg font-semibold mb-3">Find Common Free Time</h2>
                     <div class="p-3 bg-gray-50 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                 <label class="block text-sm font-medium text-gray-700 mb-2 text-left">1. Select Teachers:</label>
                                 <div id="teacher-multi-select" class="teacher-select-container text-left"></div>
                            </div>
                            <div>
                                 <label class="block text-sm font-medium text-gray-700 mb-2 text-left">2. Select Day:</label>
                                 <select id="day-select-group" class="block w-full p-2 border border-gray-300 rounded-md shadow-sm text-base mb-3"></select>
                            </div>
                        </div>
                        <button id="find-common-slots-btn" class="w-full mt-4 bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 shadow-sm text-sm font-semibold">Find Availability</button>
                    </div>
                </div>
                <div id="common-slots-results" class="mt-4"></div>
            </div>

            <!-- TEACHER VIEW -->
            <div id="teacher-view" class="view-container">
                <div class="mb-4 max-w-lg mx-auto">
                    <label class="block text-base font-medium text-gray-700 mb-2 text-center">Select a Teacher:</label>
                    <select id="teacher-select" class="block w-full p-2 border border-gray-300 rounded-md shadow-sm text-base">
                        <option value="">-- Please choose a teacher --</option>
                    </select>
                </div>
                <div id="teacher-schedule-display" class="overflow-x-auto"></div>
            </div>

            <!-- SMART CLASS VIEW -->
            <div id="class-view" class="view-container">
                <nav class="mb-4 bg-gray-50 p-2 rounded border">
                    <h2 class="text-sm font-bold text-center text-gray-600 mb-2">Select Class Group</h2>
                    <div id="class-groups" class="flex flex-wrap justify-center gap-2 mb-3"></div>
                    <div id="class-navigation" class="flex flex-wrap justify-center gap-2 pt-2 border-t border-gray-200 min-h-[40px]">
                        <span class="text-xs text-gray-400 italic py-2">Select a group above to see classes</span>
                    </div>
                </nav>
                <div id="class-schedules-container" class="mt-4"></div>
            </div>

            <!-- EDIT MANAGER VIEW -->
            <div id="edit-view" class="view-container">
                <div class="max-w-4xl mx-auto">
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200 mb-4">
                        <h2 class="text-lg font-bold text-indigo-800 mb-3 text-center">Schedule Editor</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-700 mb-1">Select Class to Edit</label>
                                <select id="edit-class-select" class="w-full p-2 border rounded text-sm bg-white"></select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-700 mb-1">Select Day</label>
                                <select id="edit-day-select" class="w-full p-2 border rounded text-sm bg-white"></select>
                            </div>
                        </div>
                    </div>
                    <div id="edit-area" class="bg-white rounded shadow border hidden">
                        <div class="p-3 bg-gray-100 border-b flex justify-between items-center">
                            <h3 id="edit-header-title" class="font-bold text-gray-700">Schedule Data</h3>
                            <button id="add-slot-btn" class="bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-2 px-4 rounded flex items-center gap-1">
                                <span>+ Add Slot</span>
                            </button>
                        </div>

                        <!-- N/A Finder Controls -->
                        <div class="p-2 bg-yellow-50 border-b flex items-center gap-2 text-xs">
                            <button id="find-na-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded font-bold">Find N/A</button>
                            <label class="flex items-center gap-1 cursor-pointer">
                                <input type="checkbox" id="filter-na-only">
                                <span>Show N/A only</span>
                            </label>
                            <span id="na-count" class="ml-auto text-yellow-800 font-mono"></span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50 text-gray-600 font-bold border-b">
                                    <tr>
                                        <th class="p-3">Period</th>
                                        <th class="p-3">Subject</th>
                                        <th class="p-3">Teacher</th>
                                        <th class="p-3">Location</th>
                                        <th class="p-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="edit-table-body" class="divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="edit-status" class="text-center mt-2 text-sm text-gray-500"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="modal">
        <div class="modal-content shadow-2xl relative w-full max-w-4xl">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <h2 class="text-xl font-bold text-gray-900 mb-4 text-center">Admin / Setup</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <h3 class="font-bold text-gray-800 mb-2 text-sm">Upload Class JSON</h3>
                    <input type="file" id="direct-json-upload" accept=".json" class="block w-full text-xs mb-3"/>
                    <button id="upload-direct-btn" class="w-full bg-indigo-600 text-white text-sm py-2 px-4 rounded hover:bg-indigo-700 font-bold">Upload Class Data</button>
                    <p id="upload-status" class="text-xs mt-2 font-mono text-center text-indigo-600 h-4"></p>
                </div>
                
                <!-- NEW: BULK DATA CORRECTION (Multi-Select) -->
                <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                    <h3 class="font-bold text-yellow-800 mb-2 text-sm">Bulk Data Correction</h3>
                    <div class="flex flex-col gap-2">
                        <!-- Type Selector -->
                        <select id="bulk-type-select" class="w-full border rounded p-1 text-xs font-bold text-gray-700">
                            <option value="teacher">Fix Teacher Name</option>
                            <option value="subject">Fix Subject Name</option>
                            <option value="location">Fix Location Name</option>
                        </select>
                        
                        <!-- Search/Filter -->
                        <input type="text" id="bulk-list-search" placeholder="Search to filter list..." class="w-full border rounded p-1 text-xs">
                        
                        <!-- Checkbox Container -->
                        <div id="bulk-checkbox-container" class="h-40 overflow-y-auto border rounded bg-white p-2 text-xs space-y-1 shadow-inner">
                            <!-- Items injected here -->
                        </div>
                        
                        <!-- New Value Input -->
                        <input id="bulk-new-value" type="text" placeholder="Enter New Value (for Replace only)" class="w-full border rounded p-1 text-xs bg-white">
                        
                        <!-- Action Buttons -->
                        <div class="flex gap-2">
                             <button id="bulk-update-btn" class="flex-1 bg-yellow-600 text-white text-xs py-2 px-2 rounded hover:bg-yellow-700 font-bold">Replace Selected</button>
                             <button id="bulk-delete-btn" class="flex-1 bg-red-600 text-white text-xs py-2 px-2 rounded hover:bg-red-700 font-bold">Delete Selected</button>
                        </div>
                    </div>
                     <p id="bulk-status" class="text-xs mt-2 font-mono text-center text-yellow-700 h-4"></p>
                </div>
            </div>

            
            <!-- NEW: MASTER DATA (Teachers / Subjects / Locations) -->
            <div class="mt-4 p-4 bg-emerald-50 rounded-lg border border-emerald-200">
                <h3 class="font-bold text-emerald-800 mb-2 text-sm">Add New Data (Teacher / Subject / Location)</h3>
                <p class="text-xs text-emerald-700 mb-3">
                    Use this if you have a new teacher, missing subject, or new location. This updates the master list used by dropdowns and summary.
                </p>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 items-end">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1">Type</label>
                        <select id="master-type-select" class="w-full border rounded p-2 text-xs font-bold bg-white">
                            <option value="teacher">Teacher</option>
                            <option value="subject">Subject</option>
                            <option value="location">Location</option>
                        </select>
                    </div>
                    <div class="sm:col-span-2">
                        <label class="block text-xs font-bold text-gray-700 mb-1">Value</label>
                        <input id="master-new-value" type="text" placeholder="Example: PN. FARAH / BM / MAKMAL SAINS" class="w-full border rounded p-2 text-xs bg-white uppercase">
                    </div>
                </div>
                <div class="flex gap-2 mt-3">
                    <button id="master-add-btn" class="flex-1 bg-emerald-600 text-white text-xs py-2 px-3 rounded hover:bg-emerald-700 font-bold">Add</button>
                    <button id="master-remove-btn" class="flex-1 bg-gray-200 text-gray-800 text-xs py-2 px-3 rounded hover:bg-gray-300 font-bold">Remove</button>
                </div>
                <p id="master-status" class="text-xs mt-2 font-mono text-center text-emerald-700 h-4"></p>
            </div>

            <div class="border-t pt-4">
                <h3 class="font-bold text-gray-800 mb-3 text-sm text-center">Database Summary (Listing)</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 h-80">
                    <div class="flex flex-col h-full">
                        <label class="text-xs font-bold text-gray-500 mb-1 flex justify-between">
                            <span>Teachers</span>
                            <span id="count-teachers" class="bg-gray-200 px-1 rounded text-gray-700">0</span>
                        </label>
                        <textarea id="list-teachers" class="flex-1 w-full border border-gray-300 rounded p-2 text-xs font-mono bg-white resize-none focus:outline-none focus:ring-1 focus:ring-indigo-500" readonly></textarea>
                    </div>
                    <div class="flex flex-col h-full">
                         <label class="text-xs font-bold text-gray-500 mb-1 flex justify-between">
                            <span>Subjects</span>
                            <span id="count-subjects" class="bg-gray-200 px-1 rounded text-gray-700">0</span>
                        </label>
                         <textarea id="list-subjects" class="flex-1 w-full border border-gray-300 rounded p-2 text-xs font-mono bg-white resize-none focus:outline-none focus:ring-1 focus:ring-indigo-500" readonly></textarea>
                    </div>
                    <div class="flex flex-col h-full">
                         <label class="text-xs font-bold text-gray-500 mb-1 flex justify-between">
                            <span>Locations</span>
                            <span id="count-locations" class="bg-gray-200 px-1 rounded text-gray-700">0</span>
                        </label>
                         <textarea id="list-locations" class="flex-1 w-full border border-gray-300 rounded p-2 text-xs font-mono bg-white resize-none focus:outline-none focus:ring-1 focus:ring-indigo-500" readonly></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF VIEWER MODAL -->
    <div id="pdf-modal" class="modal">
        <div class="modal-content relative w-full h-full max-w-6xl max-h-[90vh] flex flex-col p-0 overflow-hidden">
             <div class="bg-gray-800 text-white p-3 flex flex-wrap justify-between items-center shrink-0 gap-2">
                 <h3 class="font-bold text-sm sm:text-lg">Reference Schedule (Guru_2026.pdf)</h3>
                 
                 <!-- Page Jumper + iOS-safe open button -->
                 <div class="flex items-center gap-2">
                     <span class="text-xs text-gray-400 hidden sm:inline">Teacher:</span>
                     <select id="pdf-page-jumper" class="text-black text-xs p-1 rounded max-w-[160px]">
                         <option value="1">-- Select --</option>
                         <!-- JS will populate -->
                     </select>
                     <button id="pdf-open-tab-btn" class="bg-green-600 hover:bg-green-500 text-white text-xs px-3 py-1 rounded font-bold shadow">Open PDF</button>
                     <span id="pdf-jump-status" class="text-[10px] text-green-300 font-mono hidden sm:inline"></span>
                 </div>

                 <button id="close-pdf-btn" class="text-gray-300 hover:text-white">
                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                 </button>
             </div>
             <div class="flex-1 bg-gray-100 relative overflow-auto">
                 <!-- iOS-safe single page render -->
                 <div id="pdf-canvas-wrap" class="w-full h-full flex items-start justify-center p-2">
                     <div class="w-full max-w-4xl">
                         <div id="pdf-render-status" class="text-center text-xs text-gray-500 py-2"></div>
                         <canvas id="pdf-canvas" class="w-full bg-white shadow rounded"></canvas>
                         <div id="pdf-render-hint" class="text-center text-[11px] text-gray-400 mt-2">
                             Tip: Use “Open PDF” to open the full document in a new tab.
                         </div>
                     </div>
                 </div>
             </div>
        </div>
    </div>

    <!-- EDIT ENTRY MODAL -->
    <div id="edit-entry-modal" class="modal">
        <div class="modal-content relative p-6 w-full max-w-md">
            <h2 class="text-lg font-bold mb-4 text-indigo-700 border-b pb-2">Edit Schedule Slot</h2>
            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-bold text-gray-700 mb-1">Time Period</label>
                    <select id="edit-modal-period" class="w-full border rounded p-2 text-sm bg-white"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-700 mb-1">Subject</label>
                    <select id="edit-modal-subject" class="w-full border rounded p-2 text-sm uppercase bg-white"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-700 mb-1">Teacher</label>
                    <select id="edit-modal-teacher" class="w-full border rounded p-2 text-sm uppercase bg-white"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-700 mb-1">Location</label>
                    <select id="edit-modal-location" class="w-full border rounded p-2 text-sm uppercase bg-white"></select>
                </div>
            </div>
            <div class="mt-6 flex justify-between items-center">
                 <button id="delete-slot-btn" class="px-4 py-2 bg-red-100 text-red-700 rounded text-sm font-bold hover:bg-red-200">Delete</button>
                 <div class="flex gap-2">
                    <button id="cancel-edit-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded text-sm font-bold hover:bg-gray-300">Cancel</button>
                    <button id="save-edit-btn" class="px-4 py-2 bg-indigo-600 text-white rounded text-sm font-bold hover:bg-indigo-700">Save</button>
                 </div>
            </div>
            <div id="edit-status-msg" class="text-center mt-2 text-xs font-bold h-4"></div>
        </div>
    </div>

<script type="module">
    
    // iOS iframe safety shim (prevents undefined global errors)
    window.fireauth = null;
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, writeBatch, updateDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    let firebaseConfig = {
      apiKey: "AIzaSyBgvyb95-jujtCC2HPiHXLdYMJgQquIEx4",
      authDomain: "jadual-3f0aa.firebaseapp.com",
      projectId: "jadual-3f0aa",
      storageBucket: "jadual-3f0aa.firebasestorage.app",
      messagingSenderId: "496526436851",
      appId: "1:496526436851:web:78ff48b28bfc8c31f14a86"
    };

    if (typeof __firebase_config !== 'undefined') {
        firebaseConfig = JSON.parse(__firebase_config);
    }

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-jadual-app';
    const COLLECTION_NAME = 'school_schedules'; 

    const days = ["ISNIN", "SELASA", "RABU", "KHAMIS", "JUMAAT"];
    const REASONS = ["CRK", "UBBI", "CB", "KEM", "MSSJ", "MC", "Bengkel"];
    
    // UPDATED JUNK FILTER
    const JUNK_FILTER = [
        "LEGOLAND", "B. NILAM", "B.NILAM", "MAK.", "BENGKEL", "BGKEL", "B.LUKISAN", "KANTIN", "DEWAN", "PADANG", "BILIK", "M.KOM", "M. KOM", "PA", "PJ", "REHAT", "ASSEMBLY", "T3", "T5", "SURAU", "DATARAN", "PERHIMPUNAN", "PSS", "ISNIN", "SELASA", "RABU", "KHAMIS", "JUMAAT", "KOMPUTER", "SAINS", "FIZIK", "KIMIA", "BIO", "PJK", "RBT", "ASK", "PSV", "SEJARAH", "GEOGRAFI", "MATH", "BI", "BM", "PI", "PM", "BC", "BT", "UNKNOWN", "N/A", "GURU", "KELAS", "SUBJEK", "RELI", "LAB", "LIB", "BLK", "ARAS", "LEVEL", "LIBRARY", "&", "AHMA", "A IN",
        "1 ALKHA", "1 ALKHAWARIZMI", "1 ALKIND", "1 ALKINDI", "2 ALKHA", "2 ALKHAWARIZMI", "2 ALKIND", "2 ALKINDI", "3 AL-BUK", "3 AL-BUKHARI", "3 ALKHA", "3 ALKHAWARIZMI", "3 ALKIN", "3 ALKINDI", "4AP1", "4AP2", "4PTS", "4PTW", "4S1", "4S2", "4S3", "4SN1", "4SN2", "4TS1", "4TS2", "5AAP", "5AP", "5PTS", "5PTW", "5S1", "5S2", "5S3", "5SN1", "5SN2", "5TS1", "5TS2", "B. NILAM LAU", "B.LUKISAN IQBAL", "B.LUKISAN NIK", "BGKEL R NIVETHA", "BGKPL .E ROSLINA", "LEGOLAND FAUZI", "LEGOLAND HAJAR", "LEGOLAND HASLINA", "LEGOLAND NADIA", "M. KOM 2 NADIA", "M. KOMP 2N. MASRUL", "MAK. BIO HAJAR", "MAK. BIO NOROSNIZA", "MAK. FIZ ARFAH", "MAK. FIZ MALINA", "MAK. KIM SYAMIMI"
    ];

    // --- PDF PAGE MAPPING (Based on 2026 PDF) ---
    const TEACHER_PDF_MAPPING = {
        "ABD AZIZ": 1, "ZURAIHA": 2, "FAUZI": 3, "JUHAIDA": 4, "ZURINA": 5, "GOWRY": 6, "IMELDA": 7, "ROSLINA": 8, "AHMAD RAZIKKI": 9, "AZHARUDIN": 10,
        "EIDAYU": 11, "EFAH": 12, "GURCHAN": 13, "HANIM": 14, "HASLINA": 15, "IQBAL": 16, "IRDA": 17, "KALAIVANI": 18, "KARTINI": 19, "LAU": 20,
        "MALINA": 21, "MASJUKI": 22, "MASRIZAN": 23, "MASRULHUDA": 24, "MASRULISAH": 25, "NAZRI": 26, "RIDZUAN": 27, "ROZALI": 28, "NAZARIAH": 29, "NIK NORMAHIZAN": 30,
        "NIVETHA": 31, "NORARFAH": 32, "NOROSNIZA": 33, "SYAMIMI": 34, "NURA IDRIS": 35, "NURASHIDAH": 36, "HAZIQAH": 37, "NURUL AQILAH": 38, "RAIHAH": 39, "ROSIEATI": 40,
        "RUHAZANA": 41, "SARASWADI": 42, "SHAH RIDHA": 43, "SHARUL": 44, "SITI HAJAR": 45, "SITI NADIA": 46, "SITI HANIS": 47, "SITI NUR SALMA": 48, "NURAIN": 49, "QALILAH": 50,
        "SUHAILA": 51, "THEVANDRAN": 52, "TILLAGA": 53, "ZALIKHA": 54, "ZUHDAH": 55, "NABIHAH": 56, "FAEZAH": 57, "FARIS": 58, "IZZAH": 59, "ASIAH": 60
    };

    // --- CONNECTION STATUS HANDLER ---
    function updateStatus(state, message) {
        const dot = document.getElementById('status-dot');
        const text = document.getElementById('status-text');
        
        text.textContent = message;
        dot.className = "w-2 h-2 rounded-full";
        
        if (state === 'connecting') {
            dot.classList.add("bg-yellow-400", "animate-pulse");
        } else if (state === 'connected') {
            dot.classList.add("bg-green-500");
        } else if (state === 'error') {
            dot.classList.add("bg-red-500");
        } else if (state === 'empty') {
            dot.classList.add("bg-orange-500");
        }
    }

    // --- MASTER LISTS (Teachers / Subjects / Locations) ---
    const MASTER_LISTS_DOC = doc(db, 'artifacts', appId, 'public', 'data', 'meta', 'masterLists');
    let MASTER_LISTS = { teachers: [], subjects: [], locations: [] };

    async function loadMasterLists() {
        try {
            const snap = await getDoc(MASTER_LISTS_DOC);
            const data = snap.exists() ? snap.data() : {};
            MASTER_LISTS = {
                teachers: Array.isArray(data.teachers) ? data.teachers : [],
                subjects: Array.isArray(data.subjects) ? data.subjects : [],
                locations: Array.isArray(data.locations) ? data.locations : []
            };
        } catch (e) {
            console.warn("Failed to load MASTER_LISTS:", e);
            MASTER_LISTS = { teachers: [], subjects: [], locations: [] };
        }
        return MASTER_LISTS;
    }

    async function saveMasterLists() {
        await setDoc(MASTER_LISTS_DOC, MASTER_LISTS, { merge: true });
    }

    function normalizeMasterValue(type, value) {
        const v = (value || '').trim();
        if (!v) return '';
        if (type === 'teacher') return normalizeTeacherName(v).toUpperCase();
        return v.toUpperCase();
    }

    function addToMaster(type, value) {
        const key = type === 'teacher' ? 'teachers' : (type === 'subject' ? 'subjects' : 'locations');
        const v = normalizeMasterValue(type, value);
        if (!v) return { ok: false, msg: "Value is empty." };
        const arr = MASTER_LISTS[key] || [];
        if (arr.includes(v)) return { ok: false, msg: "Already exists." };
        arr.push(v);
        arr.sort((a,b)=>a.localeCompare(b));
        MASTER_LISTS[key] = arr;
        return { ok: true, msg: "Added." };
    }

    function removeFromMaster(type, value) {
        const key = type === 'teacher' ? 'teachers' : (type === 'subject' ? 'subjects' : 'locations');
        const v = normalizeMasterValue(type, value);
        const arr = MASTER_LISTS[key] || [];
        const idx = arr.indexOf(v);
        if (idx === -1) return { ok: false, msg: "Not found." };
        arr.splice(idx, 1);
        MASTER_LISTS[key] = arr;
        return { ok: true, msg: "Removed." };
    }

    function mergeMasterIntoSets(teachersSet, subjectsSet, locationsSet) {
        (MASTER_LISTS.teachers || []).forEach(t => teachersSet.add(t));
        (MASTER_LISTS.subjects || []).forEach(s => subjectsSet.add(s));
        (MASTER_LISTS.locations || []).forEach(l => locationsSet.add(l));
    }
    
    // Utility Functions
    function cleanTimeSlot(rawSlot) {
        if (!rawSlot || typeof rawSlot !== 'string') return "";
        const match = rawSlot.match(/\d{1,2}:\d{2}-\d{1,2}:\d{2}/);
        return match ? match[0] : "";
    }
    function timeToMinutes(t) {
        if(!t || !t.includes(':')) return 0;
        const [h, m] = t.split(':').map(Number);
        return (h < 7 ? h+12 : h)*60 + m;
    }
    function normalizeTeacherName(name) {
        if (!name) return '';
        let n = name.replace(/(PN\.?|CIK|EN\.?|UST\.?|MISS|MR\.?|USTZH\.?)/gi, '').trim().toUpperCase();
        n = n.replace(/^M\d+\s+/g, ''); n = n.replace(/^SN\s*M\d+\s+/g, '');
        return n.trim();
    }
    
    function isValidTeacher(name) {
        if (!name) return false;
        const n = name.trim().toUpperCase();
        if (n.length < 3) return false; 
        if (/^\d/.test(n)) return false;
        if (JUNK_FILTER.some(junk => n.includes(junk))) return false;
        return true;
    }
    
    function getSubjectStyle(subject) {
        if (!subject) return '';
        const s = subject.trim().toUpperCase();
        if (s.includes('REHAT')) return 'background-color: #fef08a; color: #854d0e;';
        let hash = 0;
        for (let i = 0; i < s.length; i++) hash = s.charCodeAt(i) + ((hash << 5) - hash);
        const hue = Math.abs(hash % 360);
        return `background-color: hsl(${hue}, 80%, 94%); color: hsl(${hue}, 70%, 25%); border: 1px solid hsl(${hue}, 60%, 85%);`;
    }

    function processSchedules(schedules) {
        const processed = {};
        schedules.forEach(classSchedule => {
            days.forEach(day => {
                if (classSchedule.scheduleData[day]) {
                    classSchedule.scheduleData[day].forEach(entry => {
                        if (entry.teacher) {
                            const teachers = entry.teacher.split(/\s*\/\s*/);
                            teachers.forEach(t => {
                                const teacherName = normalizeTeacherName(t);
                                if (isValidTeacher(teacherName)) {
                                    if (!processed[teacherName]) processed[teacherName] = { schedule: { ISNIN: [], SELASA: [], RABU: [], KHAMIS: [], JUMAAT: [] }, subjects: new Set() };
                                    processed[teacherName].schedule[day].push({ 
                                        period: cleanTimeSlot(entry.period), 
                                        subject: entry.subject,
                                        className: classSchedule.className
                                    });
                                }
                            });
                        }
                    });
                }
            });
        });
        return processed;
    }
    
    function findCoveringPeriod(slot, busyPeriods) {
        if(!busyPeriods) return null;
        for (const busyPeriod of busyPeriods) {
             if (busyPeriod.period === slot) return busyPeriod;
        }
        return null;
    }

    function calculateLoadScore(teacherName, teacherData, day, targetSlot) {
        const schedule = teacherData[teacherName]?.schedule[day] || [];
        if (findCoveringPeriod(targetSlot, schedule)) return 999; 
        const [startStr, endStr] = targetSlot.split('-');
        if(!startStr || !endStr) return 0; 
        const targetStart = timeToMinutes(startStr);
        const targetEnd = timeToMinutes(endStr);
        let hasBefore = false, hasAfter = false;
        schedule.forEach(s => {
            const [sStartStr, sEndStr] = s.period.split('-');
            const sEnd = timeToMinutes(sEndStr);
            const sStart = timeToMinutes(sStartStr);
            if (Math.abs(sEnd - targetStart) < 5) hasBefore = true;
            if (Math.abs(sStart - targetEnd) < 5) hasAfter = true;
        });
        if (hasBefore && hasAfter) return 2; 
        if (hasBefore || hasAfter) return 1; 
        return 0; 
    }

    // --- MAIN INIT ---
    function initializeUI(allSchedules) {
        document.getElementById('loading-indicator').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        
        const today = new Date();
        document.getElementById('current-day-display').textContent = today.toLocaleDateString('ms-MY', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        const teacherData = processSchedules(allSchedules);
        const dayIdx = today.getDay();
        const currentDayName = (dayIdx >= 1 && dayIdx <= 5) ? days[dayIdx-1] : "ISNIN";
        
        if (allSchedules.length === 0) {
            updateStatus('empty', 'Database Empty. Please upload JSON.');
            // Auto open settings if empty
            document.getElementById('settings-modal').classList.add('open');
        } else {
            updateStatus('connected', `Data Loaded (${allSchedules.length} classes)`);
        }

        setupReliefView(currentDayName, allSchedules, teacherData);
        setupGroupAvailabilityView(currentDayName, allSchedules, teacherData);
        setupTeacherView(currentDayName, allSchedules, teacherData);
        setupSmartClassView(currentDayName, allSchedules);
        setupEditView(allSchedules); 
        setupViewToggler();
        setupSettingsModal(allSchedules); 
        setupPDFViewer(); // Init PDF Viewer
    }

    function setupPDFViewer() {
        const btn = document.getElementById('view-pdf-btn');
        const modal = document.getElementById('pdf-modal');
        const close = document.getElementById('close-pdf-btn');
        const jumper = document.getElementById('pdf-page-jumper');
        const openBtn = document.getElementById('pdf-open-tab-btn');
        const status = document.getElementById('pdf-jump-status');
        const renderStatus = document.getElementById('pdf-render-status');
        const canvas = document.getElementById('pdf-canvas');
        const wrap = document.getElementById('pdf-canvas-wrap');
        if (wrap) {
            wrap.style.position = 'relative';
            let layer = document.getElementById('pdf-highlight-layer');
            if (!layer) {
                layer = document.createElement('div');
                layer.id = 'pdf-highlight-layer';
                layer.style.position = 'absolute';
                layer.style.left = '0';
                layer.style.top = '0';
                layer.style.right = '0';
                layer.style.bottom = '0';
                layer.style.pointerEvents = 'none';
                wrap.appendChild(layer);
            }
        }

        const baseUrl = "Guru_2026.pdf";

        // iOS/Safari note:
        // - PDF fragment jumps (#page=) are unreliable inside <iframe>
        // - Native PDF viewers show continuous pages (you may see "more than one page")
        // Solution:
        // - Render ONLY the selected page using PDF.js inside the modal
        // - "Open PDF" opens a dedicated single-page view (this same app in a new tab)
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        let lastTeacher = null;

        // PDF.js setup
        const pdfjs = window.pdfjsLib;
        // iOS / WebView safety: disable worker to avoid cross-origin worker issues
        if (pdfjs && isIOS) { try { pdfjs.disableWorker = true; } catch (_) {} }
        let pdfDoc = null;
        if (pdfjs && pdfjs.GlobalWorkerOptions) {
            // Use CDN worker for reliability
            pdfjs.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
            // iOS Safari is more stable without a web worker for PDF.js
            if (isIOS) {
                try { pdfjs.disableWorker = true; } catch (_) {}
            }
        }

        async function ensurePdfLoaded() {
            if (location.protocol === 'file:') {
                throw new Error('PDF preview requires HTTPS hosting (not file://).');
            }
            if (!pdfjs) throw new Error('PDF.js not loaded');
            if (pdfDoc) return pdfDoc;
            if (renderStatus) renderStatus.textContent = 'Loading PDF…';
            if (!/^https?:$/i.test(location.protocol)) {
                throw new Error('PDF preview requires https hosting (GitHub Pages).');
            }
            pdfDoc = await pdfjs.getDocument({ url: baseUrl, disableRange: true, disableStream: true, disableAutoFetch: true }).promise;
            return pdfDoc;
        }

        async function renderPage(pageNum) {
            try {
                const doc = await ensurePdfLoaded();
                const page = await doc.getPage(Math.max(1, Math.min(pageNum || 1, doc.numPages)));

                // Fit to container width
                const wrap = document.getElementById('pdf-canvas-wrap');
                const maxW = (wrap?.clientWidth || window.innerWidth) - 24;
                const viewport1 = page.getViewport({ scale: 1 });
                const scale = Math.max(0.5, Math.min(3, maxW / viewport1.width));
                const viewport = page.getViewport({ scale });

                const ctx = canvas.getContext('2d');
                canvas.width = Math.floor(viewport.width);
                canvas.height = Math.floor(viewport.height);
                if (renderStatus) renderStatus.textContent = `Showing page ${pageNum}`;
                await page.render({ canvasContext: ctx, viewport }).promise;
                canvas.__pageViewport = viewport;

                // --- Overlay highlights (relief assignments) ---
                // Best-effort mapping of (day, time) into the timetable grid.
                try {
                    const daySel = document.getElementById('relief-day-select');
                    const dayKeyRaw = String((daySel && daySel.value) || '').trim();
                    const dayKey = dayKeyRaw.toUpperCase();
                    const teacherUpper = String((jumper && jumper.value) || '').trim().toUpperCase();

                    // Gather all assigned time ranges for this teacher on the selected day
                    const timeRanges = [];
                    const slotCards = document.querySelectorAll('#relief-slots > div');
                    slotCards.forEach(card => {
                        const sel = card.querySelector('select');
                        const timeEl = card.querySelector('span');
                        if (!sel || !timeEl) return;
                        const val = String(sel.value || '').trim().toUpperCase();
                        if (!val) return;
                        if (val === teacherUpper) {
                            const t = String(timeEl.textContent || '').trim();
                            if (t && t.includes('-')) timeRanges.push(t);
                        }
                    });

                    // If nothing in the list yet, fallback to last-clicked slot highlight
                    if (timeRanges.length === 0 && window.__pdfHighlight) {
                        const h = window.__pdfHighlight;
                        if (String(h.teacherName || '').trim().toUpperCase() === teacherUpper &&
                            String(h.dayKey || '').trim().toUpperCase() === dayKey) {
                            const t = String(h.slot || '').trim();
                            if (t && t.includes('-')) timeRanges.push(t);
                        }
                    }

                    if (timeRanges.length) {
                        // Use the actual PDF canvas dimensions; `viewer` is not defined in this build.
                        const W = canvas.width, H = canvas.height;
                        const gridLeft = W * 0.17;
                        const gridRight = W * 0.975;
                        const gridTop = H * 0.24;
                        const gridBottom = H * 0.93;
	                        // NOTE: Use double-quoted keys to avoid breaking on JUMA'AT.
	                        const dayMap = { "ISNIN": 0, "MON": 0, "MONDAY": 0,
	                                         "SELASA": 1, "TUE": 1, "TUESDAY": 1,
	                                         "RABU": 2, "WED": 2, "WEDNESDAY": 2,
	                                         "KHAMIS": 3, "THU": 3, "THURSDAY": 3,
	                                         "JUMAAT": 4, "JUMA'AT": 4, "FRI": 4, "FRIDAY": 4 };
                        const dayIdx = (dayMap[dayKey] != null) ? dayMap[dayKey] : 4;
                        const rowH = (gridBottom - gridTop) / 5;

                        // Time boundaries used for proportional column mapping
                        const bounds = [
                            7*60+15, 7*60+45, 8*60+15, 8*60+45, 9*60+15, 9*60+45,
                            10*60+0, 10*60+15, 10*60+30, 11*60+0, 11*60+30,
                            12*60+0, 12*60+30, 13*60+0, 13*60+30,
                            14*60+0, 14*60+30, 15*60+0, 15*60+30
                        ];
                        const segs = bounds.length - 1;
                        const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
                                                function toMinutes(t){
                            const m = String(t || '').trim().match(/(\d{1,2})\s*[:\.]\s*(\d{2})/);
                            if (!m) return null;
                            return parseInt(m[1], 10)*60 + parseInt(m[2], 10);
                        }
                        function nearestIndex(mins){
                            let best = 0, bestD = Infinity;
                            for (let i=0;i<bounds.length;i++){
                                const d = Math.abs(bounds[i]-mins);
                                if (d < bestD){ bestD=d; best=i; }
                            }
                            return best;
                        }

                        // Draw highlights on a dedicated overlay canvas (layered above the PDF canvas)
                        // so they remain visible and are not overwritten by pdf.js internal re-renders.
                        const wrap = document.getElementById('pdfPageWrap') || canvas.parentElement;
                        if (wrap) wrap.style.position = wrap.style.position || 'relative';
                        let ov = document.getElementById('pdfHighlightOverlay');
                        if (!ov) {
                            ov = document.createElement('canvas');
                            ov.id = 'pdfHighlightOverlay';
                            ov.style.position = 'absolute';
                            ov.style.left = '0';
                            ov.style.top = '0';
                            ov.style.width = '100%';
                            ov.style.height = '100%';
                            ov.style.pointerEvents = 'none';
                            ov.style.zIndex = '5';
                            wrap.appendChild(ov);
                        }
                        ov.width = canvas.width;
                        ov.height = canvas.height;
                        const octx = ov.getContext('2d');
                        octx.clearRect(0, 0, ov.width, ov.height);

                        octx.save();
                        octx.globalAlpha = 0.35;
                        octx.fillStyle = '#FFD54F';
                        octx.strokeStyle = '#FF6F00';
                        octx.lineWidth = Math.max(2, W * 0.0025);

                        const y = gridTop + dayIdx * rowH;
                        const h = rowH;

                        timeRanges.forEach(tr => {
                            const m = String(tr).match(/(\d{1,2}\s*[:\.]\s*\d{2})\s*-\s*(\d{1,2}\s*[:\.]\s*\d{2})/);
                            if (!m) return;
                            const sMin = toMinutes(m[1]);
                            const eMin = toMinutes(m[2]);
                            if (sMin == null || eMin == null) return;
                            const i0 = clamp(nearestIndex(sMin), 0, segs-1);
                            const i1 = clamp(nearestIndex(eMin), 1, segs);
                            const x0 = gridLeft + (i0 / segs) * (gridRight - gridLeft);
                            const x1 = gridLeft + (i1 / segs) * (gridRight - gridLeft);
                            const w = Math.max(4, x1 - x0);
                            octx.fillRect(x0, y, w, h);
                            octx.strokeRect(x0, y, w, h);
                        });

                        octx.restore();
                    }
                } catch (e) {
                    console.warn('PDF highlight overlay skipped:', e);
                }


                // Highlight ALL relief assignments for the currently-selected teacher (visual representation)
                try {
                    const currentTeacher = (window.__pdfCurrentTeacher || '').trim();
                    if (currentTeacher && window.__pdfAvail && typeof window.__pdfAvail.ensureGrid === 'function') {
                        await window.__pdfAvail.ensureGrid();

                        // Collect highlights from current Relief Assignment UI (same selected day)
                        const dayKey = String((document.getElementById('relief-day-select')?.value || '')).toUpperCase();
                        const highlights = [];
                        document.querySelectorAll('.relief-select').forEach(sel => {
                            try {
                                const v = String(sel.value || '').trim();
                                if (!v || v.toUpperCase() != currentTeacher.toUpperCase()) return;
                                const det = JSON.parse(sel.dataset.details || '{}');
                                if (!det || !det.period) return;
                                highlights.push({ day: dayKey, slot: String(det.period) });
                            } catch (_) {}
                        });

                        // Also include any explicit highlight request (single-slot jump)
                        if (window.__pdfHighlight && window.__pdfHighlight.page === pageNum) {
                            highlights.push({ day: window.__pdfHighlight.day, slot: window.__pdfHighlight.slot });
                        }

                        // De-duplicate
                        const seen = new Set();
                        const uniq = highlights.filter(h => {
                            const k = `${h.day}::${h.slot}`;
                            if (seen.has(k)) return false;
                            seen.add(k);
                            return true;
                        });

                        // Draw overlay rectangles
                        if (uniq.length) {
                            for (const h of uniq) {
                                const b = window.__pdfAvail.getRangeBounds ? window.__pdfAvail.getRangeBounds(h.day, h.slot) : (window.__pdfAvail.getCellBounds ? window.__pdfAvail.getCellBounds(h.day, h.slot) : null);
                                if (!b) continue;
                                // Convert PDF-space bounds into canvas (viewport) space (y-axis corrected)
                                const rect = viewport.convertToViewportRectangle([b.xMin, b.yMin, b.xMax, b.yMax]);
                                const x = Math.max(0, Math.floor(Math.min(rect[0], rect[2])));
                                const yTop = Math.max(0, Math.floor(Math.min(rect[1], rect[3])));
                                const w = Math.max(1, Math.floor(Math.abs(rect[2] - rect[0])));
                                const hgt = Math.max(1, Math.floor(Math.abs(rect[3] - rect[1])));

                                // Reuse the same overlay canvas if available; fall back to PDF canvas.
                                const drawCtx = (typeof octx !== 'undefined' && octx) ? octx : ctx;
                                drawCtx.save();
                                drawCtx.fillStyle = 'rgba(34, 197, 94, 0.20)';
                                drawCtx.strokeStyle = 'rgba(21, 128, 61, 0.95)';
                                drawCtx.lineWidth = 3;
                                drawCtx.fillRect(x, yTop, w, hgt);
                                drawCtx.strokeRect(x, yTop, w, hgt);
                                drawCtx.restore();
                            }
                        }
                    }
                } catch (_) {}

	            } catch (err) {
	                if (err && (err.name === 'RenderingCancelledException' || String(err).includes('Rendering cancelled'))) { return; }
	                // iOS Safari often logs Error objects as `{}`; expand it for debugging.
	                const errInfo = {
	                    name: err?.name,
	                    message: err?.message,
	                    stack: err?.stack,
	                    asString: (() => { try { return String(err); } catch (_) { return null; } })()
	                };
	                console.error('PDF render error:', errInfo);
	                if (renderStatus) renderStatus.textContent = `Unable to render PDF preview here. (${errInfo.message || errInfo.asString || "Unknown error"}) Tap "Open PDF" to open the page in a new tab.`;
	            }
        }



        // ============================
        // PDF AUTHORITY AVAILABILITY (Option 1)
        // Uses FARIS as reference to auto-calibrate PDF grid, then decides FREE/BUSY for a teacher at a given day+slot.
        // ============================
        const PDF_AUTH = (() => {
            const REF_TEACHER = "FARIS";
            const cache = new Map(); // key: teacher|day|slot -> 'FREE'|'BUSY'|'UNKNOWN'
            let grid = null;
            let loadingGrid = null;

            const DAY_KEYS = ["ISNIN","SELASA","RABU","KHAMIS","JUMAAT"];

            function normTeacherKey(name) {
                const n = normalizeTeacherName(name || "").toUpperCase();
                const keys = Object.keys(TEACHER_PDF_MAPPING);
                if (keys.includes(n)) return n;
                const found = keys.find(k => n.includes(k) || k.includes(n));
                return found || "";
            }

            function normTime(s) {
                const m = String(s || "").trim().replace(/\./g, ':').match(/(\d{1,2}):(\d{2})/);
                if (!m) return "";
                const hh = String(parseInt(m[1], 10)).padStart(2, '0');
                const mm = String(parseInt(m[2], 10)).padStart(2, '0');
                return `${hh}:${mm}`;
            }

            function slotStart(slot) {
                const st = String(slot || "").split('-')[0];
                return normTime(st);
            }

            function timeToMin(t) {
                const m = String(t || "").match(/(\d{1,2}):(\d{2})/);
                if (!m) return 0;
                return parseInt(m[1], 10) * 60 + parseInt(m[2], 10);
            }

            function isTimeToken(txt) {
                return /(\d{1,2}[:.]\d{2})/.test(txt);
            }

            async function ensureGrid() {
                if (grid) return grid;
                if (loadingGrid) return loadingGrid;

                loadingGrid = (async () => {
                    const doc = await ensurePdfLoaded();
                    const refKey = normTeacherKey(REF_TEACHER) || REF_TEACHER;
                    const refPageNo = TEACHER_PDF_MAPPING[refKey] || 1;

                    const page = await doc.getPage(refPageNo);
                    const viewport = page.getViewport({ scale: 1 });
                    const text = await page.getTextContent();

                    const times = new Map(); // t -> xs[]
                    const daysPos = {};      // day -> y

                    let maxY = 0;
                    for (const it of (text.items || [])) {
                        const tr = it.transform || [];
                        const y = tr[5] ?? 0;
                        if (y > maxY) maxY = y;
                    }

                    // In PDF.js coordinate system, larger y is closer to the top.
                    const TOP_Y = maxY * 0.80;

                    for (const it of (text.items || [])) {
                        const s = (it.str || '').trim();
                        if (!s) continue;
                        const tr = it.transform || [];
                        const x = tr[4] ?? 0;
                        const y = tr[5] ?? 0;
                        const up = s.toUpperCase();

                        if (DAY_KEYS.includes(up)) {
                            if (!daysPos[up] || y > daysPos[up]) daysPos[up] = y;
                            continue;
                        }

                        if (y >= TOP_Y && isTimeToken(s)) {
                            const t = normTime(s);
                            if (!t) continue;
                            if (!times.has(t)) times.set(t, []);
                            times.get(t).push(x);
                        }
                    }

                    const timeList = [];
                    for (const [t, xs] of times.entries()) {
                        if (!xs || xs.length === 0) continue;
                        xs.sort((a, b) => a - b);
                        const mid = xs[Math.floor(xs.length / 2)];
                        timeList.push({ t, x: mid });
                    }
                    timeList.sort((a, b) => a.x - b.x);

                    if (timeList.length < 6) {
                        grid = { ok: false, reason: 'Not enough time columns detected on FARIS page.' };
                        return grid;
                    }

                    const xBounds = {};
                    for (let i = 0; i < timeList.length; i++) {
                        const cur = timeList[i];
                        const left = timeList[i - 1];
                        const right = timeList[i + 1];
                        const minX = left ? (left.x + cur.x) / 2 : 0;
                        const maxX = right ? (cur.x + right.x) / 2 : viewport.width;
                        xBounds[cur.t] = { minX, maxX };
                    }

                    const dayList = Object.entries(daysPos)
                        .map(([d, y]) => ({ d, y }))
                        .sort((a, b) => b.y - a.y); // top to bottom

                    const yBounds = {};
                    for (let i = 0; i < dayList.length; i++) {
                        const cur = dayList[i];
                        const above = dayList[i - 1];
                        const below = dayList[i + 1];
                        const maxYb = above ? (above.y + cur.y) / 2 : viewport.height;
                        const minYb = below ? (cur.y + below.y) / 2 : 0;
                        yBounds[cur.d] = { minY: minYb, maxY: maxYb };
                    }

                    grid = { ok: true, timeList, xBounds, yBounds };
                    return grid;
                })();

                return loadingGrid;
            }

            function pickNearestTimeColumn(startHHMM, timeList) {
                const target = timeToMin(startHHMM);
                let best = timeList[0];
                let bestDist = Math.abs(timeToMin(best.t) - target);
                for (const item of timeList) {
                    const d = Math.abs(timeToMin(item.t) - target);
                    if (d < bestDist) {
                        best = item;
                        bestDist = d;
                    }
                }
                return best;
            }

            function cellHasText(items, xMin, xMax, yMin, yMax) {
                for (const it of (items || [])) {
                    const s = (it.str || '').trim();
                    if (!s) continue;
                    const up = s.toUpperCase();
                    if (DAY_KEYS.includes(up)) continue;
                    if (isTimeToken(s)) continue;

                    const tr = it.transform || [];
                    const x = tr[4] ?? 0;
                    const y = tr[5] ?? 0;

                    if (x >= xMin && x <= xMax && y >= yMin && y <= yMax) {
                        if (s.length >= 2) return true;
                    }
                }
                return false;
            }

            async function isFree(teacherName, day, slot) {
                const teacherKey = normTeacherKey(teacherName);
                const d = String(day || '').toUpperCase();
                const st = slotStart(slot);

                if (!teacherKey || !TEACHER_PDF_MAPPING[teacherKey] || !DAY_KEYS.includes(d) || !st) {
                    return 'UNKNOWN';
                }

                const cacheKey = `${teacherKey}|${d}|${slot}`;
                if (cache.has(cacheKey)) return cache.get(cacheKey);

                const g = await ensureGrid();
                if (!g || !g.ok) {
                    cache.set(cacheKey, 'UNKNOWN');
                    return 'UNKNOWN';
                }

                const doc = await ensurePdfLoaded();
                const pageNo = TEACHER_PDF_MAPPING[teacherKey] || 1;
                const page = await doc.getPage(pageNo);
                const text = await page.getTextContent();

                const timeCol = pickNearestTimeColumn(st, g.timeList);
                const xb = g.xBounds[timeCol.t];
                const yb = g.yBounds[d];

                if (!xb || !yb) {
                    cache.set(cacheKey, 'UNKNOWN');
                    return 'UNKNOWN';
                }

                const busy = cellHasText(text.items, xb.minX, xb.maxX, yb.minY, yb.maxY);
                const status = busy ? 'BUSY' : 'FREE';
                cache.set(cacheKey, status);
                return status;
            }

            function getCellBounds(day, slot) {
                const d = String(day || "").toUpperCase();
                const st = slotStart(slot);
                if (!DAY_KEYS.includes(d) || !st) return null;
                if (!grid || !grid.ok) return null;
                const timeCol = pickNearestTimeColumn(st, grid.timeList);
                const xb = grid.xBounds[timeCol.t];
                const yb = grid.yBounds[d];
                if (!xb || !yb) return null;
                return { xMin: xb.minX, xMax: xb.maxX, yMin: yb.minY, yMax: yb.maxY, col: timeCol.t };
            }

            function slotEnd(slot) {
                const parts = String(slot || '').trim().split('-');
                if (parts.length < 2) return '';
                return normTime(parts[1]);
            }

            function getRangeBounds(day, slotRange) {
                const d = String(day || '').toUpperCase();
                const st = slotStart(slotRange);
                const en0 = slotEnd(slotRange);
                if (!DAY_KEYS.includes(d) || !st) return null;
                if (!grid || !grid.ok) return null;

                // Start column
                const startCol = pickNearestTimeColumn(st, grid.timeList);
                const xb1 = grid.xBounds[startCol.t];

                // End column: use end time minus 1 minute so we land inside the final covered column
                let endTime = en0;
                if (endTime) {
                    const mins = timeToMin(endTime);
                    const adj = Math.max(0, mins - 1);
                    const hh = String(Math.floor(adj / 60)).padStart(2, '0');
                    const mm = String(adj % 60).padStart(2, '0');
                    endTime = `${hh}:${mm}`;
                }
                const endCol = endTime ? pickNearestTimeColumn(endTime, grid.timeList) : startCol;
                const xb2 = grid.xBounds[endCol.t];

                const yb = grid.yBounds[d];
                if (!xb1 || !xb2 || !yb) return null;

                const xMin = Math.min(xb1.minX, xb2.minX);
                const xMax = Math.max(xb1.maxX, xb2.maxX);
                return { xMin, xMax, yMin: yb.minY, yMax: yb.maxY, colStart: startCol.t, colEnd: endCol.t };
            }

            async function annotateSelect(selectEl, rankedList, day, slot) {
                if (!selectEl || !Array.isArray(rankedList) || rankedList.length === 0) return;

                const prevVal = selectEl.value;
                selectEl.disabled = true;

                const limited = rankedList.slice(0, 30);
                const results = [];

                for (const r of limited) {
                    const st = await isFree(r.name, day, slot);
                    results.push({ ...r, pdf: st });
                }

                const grp = (x) => x.pdf === 'FREE' ? 0 : (x.pdf === 'UNKNOWN' ? 1 : 2);
                results.sort((a, b) => (grp(a) - grp(b)) || (a.score - b.score) || a.name.localeCompare(b.name));

                                // Preserve the current selection even if it is not in the new ranked list
                let optionsHtml = `<option value="">-- Assign --</option>`;

                // If user already assigned someone (prevVal), keep it visible and selected
                if (prevVal && prevVal.trim()) {
                    const prevName = prevVal.trim();
                    const existsInResults = results.some(x => x.name === prevName);
                    if (!existsInResults) {
                        const stPrev = await isFree(prevName, day, slot);
                        const tagPrev = stPrev === 'FREE' ? '(FREE-PDF)' : (stPrev === 'BUSY' ? '(BUSY-PDF)' : '(UNKNOWN-PDF)');
                        optionsHtml += `<option value="${prevName}">${prevName} (ASSIGNED) ${tagPrev}</option>`;
                    }
                }

                for (const r of results) {
                    const tag = r.pdf === 'FREE' ? '(FREE-PDF)' : (r.pdf === 'BUSY' ? '(BUSY-PDF)' : '(UNKNOWN-PDF)');
                    optionsHtml += `<option value="${r.name}">${r.name} ${tag}</option>`;
                }

                selectEl.innerHTML = optionsHtml;

                // Restore existing selection if present
                if (prevVal && prevVal.trim()) {
                    selectEl.value = prevVal;
                } else {
                    // AUTO-PICK (Improved): choose the best PDF-eligible candidate that does NOT create
                    // a same-time collision (one relief teacher cannot cover 2 classes at the same period).
                    // Preference order: FREE-PDF (no collision) -> UNKNOWN-PDF (no collision) -> leave blank.

                    // Build a set of teachers already assigned in any OVERLAPPING time range.
                    // (Important: slots can overlap, e.g. 7:15-8:15 and 7:45-8:15.)
                    const usedAtOverlap = new Set();

                    const toMinutes = (t) => {
                        const m = String(t || '').trim().replace('.', ':').match(/(\d{1,2}):(\d{2})/);
                        if (!m) return null;
                        const hh = parseInt(m[1], 10);
                        const mm = parseInt(m[2], 10);
                        return (hh * 60) + mm;
                    };

                    const rangeTo = (rng) => {
                        const parts = String(rng || '').trim().split('-');
                        if (parts.length < 2) return null;
                        const a = toMinutes(parts[0]);
                        const b = toMinutes(parts[1]);
                        if (a == null || b == null) return null;
                        return { start: a, end: b };
                    };

                    const overlaps = (a, b) => {
                        const ra = rangeTo(a);
                        const rb = rangeTo(b);
                        if (!ra || !rb) return false;
                        // Treat touching edges as non-overlap (end==start is OK)
                        return ra.start < rb.end && rb.start < ra.end;
                    };

                    try {
                        const all = document.querySelectorAll('.relief-select');
                        all.forEach(other => {
                            if (!other || other === selectEl) return;
                            const det = JSON.parse(other.dataset.details || '{}');
                            if (!other.value || !det || !det.period) return;
                            if (overlaps(det.period, slot)) usedAtOverlap.add(String(other.value).trim());
                        });
                    } catch (e) {}

                    // Smarter constraints:
                    // 1) No overlap (already enforced via usedAtOverlap)
                    // 2) No back-to-back (or too-short gap) for the same relief teacher
                    // 3) Workload balancing: avoid over-assigning one teacher in a day

                    const MIN_GAP_MINUTES = 20;       // rest buffer
                    const MAX_ASSIGNMENTS_PER_DAY = 2; // soft cap

                    // Build current assigned ranges per teacher (for this day view)
                    const assigned = new Map(); // name -> [{start,end}]
                    try {
                        const all = document.querySelectorAll('.relief-select');
                        all.forEach(other => {
                            if (!other || !other.value) return;
                            const nm = String(other.value).trim();
                            const det = JSON.parse(other.dataset.details || '{}');
                            if (!det || !det.period) return;
                            const rr = rangeTo(det.period);
                            if (!rr) return;
                            if (!assigned.has(nm)) assigned.set(nm, []);
                            assigned.get(nm).push(rr);
                        });
                    } catch (e) {}

                    const slotRange = rangeTo(slot);

                    const teacherCount = (name) => (assigned.get(String(name).trim()) || []).length;

                    const minGapToSlot = (name) => {
                        const list = assigned.get(String(name).trim()) || [];
                        if (!slotRange) return Infinity;
                        let best = Infinity;
                        for (const rr of list) {
                            // Overlap already handled, but keep safe:
                            if (rr.start < slotRange.end && slotRange.start < rr.end) {
                                return 0;
                            }
                            if (rr.end <= slotRange.start) {
                                best = Math.min(best, slotRange.start - rr.end);
                            } else if (rr.start >= slotRange.end) {
                                best = Math.min(best, rr.start - slotRange.end);
                            }
                        }
                        return best;
                    };

                    const isBackToBack = (name) => {
                        const gap = minGapToSlot(name);
                        return gap <= MIN_GAP_MINUTES;
                    };

	                    const canUse = (name, allowShortGap = false) => {
                        const nm = String(name || '').trim();
                        if (!nm) return false;
                        if (usedAtOverlap.has(nm)) return false;
	                        // hard reject if back-to-back (or too short gap)
	                        // If we cannot fill all slots, we will relax this constraint as a last resort.
	                        if (!allowShortGap && isBackToBack(nm)) return false;
                        // soft cap: allow if under cap; if everyone exceeds cap, we may relax later
                        return true;
                    };

                    // Candidate scoring (Option A: smarter):
                    // - HARD prefer FREE-PDF (known free in timetable)
                    // - UNKNOWN-PDF only if necessary (PDF text parsing could not confirm)
                    // - Enforce: no overlap, >= MIN_GAP_MINUTES rest gap, and max 2 assignments/day
                    // - Balance workload: prefer teachers with fewer assignments today

                    const pdfBonus = (p) => (p === 'FREE' ? 100 : (p === 'UNKNOWN' ? 10 : -1000));

	                    const eligible = results
	                        .filter(r => (r.pdf === 'FREE' || r.pdf === 'UNKNOWN') && canUse(r.name, false))
	                        .filter(r => teacherCount(r.name) < MAX_ASSIGNMENTS_PER_DAY);

	                    // If everyone is already at cap, allow candidates at/over cap (still no overlap / no back-to-back)
	                    const relaxedCap = results
	                        .filter(r => (r.pdf === 'FREE' || r.pdf === 'UNKNOWN') && canUse(r.name, false));

	                    // Last-resort: if we still cannot fill a slot, relax the rest-gap constraint (still no overlap)
	                    const relaxedGap = results
	                        .filter(r => (r.pdf === 'FREE' || r.pdf === 'UNKNOWN') && canUse(r.name, true))
	                        .filter(r => teacherCount(r.name) < MAX_ASSIGNMENTS_PER_DAY);

	                    const pool = eligible.length
	                        ? eligible
	                        : (relaxedCap.length ? relaxedCap : relaxedGap);

                    // Score: higher is better
                    const scoreCandidate = (r) => {
                        const nm = String(r.name||'').trim();
                        const count = teacherCount(nm);
                        const gap = minGapToSlot(nm);
                        const gapPenalty = (gap < 60 ? (60 - gap) * 0.2 : 0);
                        return (pdfBonus(r.pdf)
                            - (count * 25)
                            - gapPenalty
                            - (r.score * 0.05));
                    };

                    let pick = null;
                    if (pool.length) {
                        pool.sort((a,b) =>
                            (scoreCandidate(b) - scoreCandidate(a)) ||
                            (teacherCount(a.name) - teacherCount(b.name)) ||
                            a.name.localeCompare(b.name)
                        );
                        pick = pool[0];
                    }

                    if (pick && pick.name) {
                        selectEl.value = pick.name;
                        // Trigger downstream persistence + conflict checks
                        selectEl.dispatchEvent(new Event('change', { bubbles: true }));
                    } else {
                        // Fallback (last resort): allow back-to-back only if NOTHING else fits.
                        // Still blocks true time overlaps.
                        const fallbackPool = results
                            .filter(r => (r.pdf === 'FREE' || r.pdf === 'UNKNOWN'))
                            .filter(r => {
                                const nm = String(r.name || '').trim();
                                if (!nm) return false;
                                if (usedAtOverlap.has(nm)) return false;
                                return true;
                            });

                        if (fallbackPool.length) {
                            fallbackPool.sort((a,b) =>
                                (scoreCandidate(b) - scoreCandidate(a)) ||
                                (teacherCount(a.name) - teacherCount(b.name)) ||
                                a.name.localeCompare(b.name)
                            );
                            const fb = fallbackPool[0];
                            if (fb && fb.name) {
                                selectEl.value = fb.name;
                                selectEl.dispatchEvent(new Event('change', { bubbles: true }));
                                selectEl.setAttribute('data-relaxed-assign', '1');
                            } else {
                                selectEl.value = '';
                            }
                        } else {
                            // No safe candidate found; keep unassigned
                            selectEl.value = '';
                        }
                    }
                }

                selectEl.disabled = false;
            }

            return { ensureGrid, isFree, annotateSelect, getCellBounds };
        })();

        // Expose globally so Relief View can use it
        window.__pdfAvail = PDF_AUTH;

        // Populate Dropdown (teacher -> page)
        jumper.innerHTML = '<option value="1">-- Select --</option>';
        Object.keys(TEACHER_PDF_MAPPING).sort().forEach((key) => {
            const opt = document.createElement('option');
            opt.value = TEACHER_PDF_MAPPING[key];
            opt.text = key;
            jumper.appendChild(opt);
        });

        // Determine best page based on current UI context
        const findActiveTeacher = () => {
            if (lastTeacher) return lastTeacher;
            const teacherSelect = document.getElementById('teacher-select');
            if (teacherSelect && teacherSelect.value && document.getElementById('teacher-view').classList.contains('active')) {
                return teacherSelect.value;
            }
            const absentContainer = document.getElementById('absent-teacher-multiselect');
            if (absentContainer && document.getElementById('relief-view').classList.contains('active')) {
                const checked = absentContainer.querySelector('input:checked');
                if (checked) return checked.value;
            }
            return null;
        };

        const getPageForTeacher = (teacherName) => {
            if (!teacherName) return { page: 1, label: 'Index' };
            const norm = normalizeTeacherName(teacherName);
            const foundKey = Object.keys(TEACHER_PDF_MAPPING).find(k => norm.includes(k) || k.includes(norm));
            if (foundKey) return { page: TEACHER_PDF_MAPPING[foundKey], label: foundKey };
            return { page: 1, label: 'Index' };
        };

        const syncToTeacher = (teacherName, notePrefix = 'Auto') => {
            if (teacherName) lastTeacher = teacherName;
            const { page, label } = getPageForTeacher(teacherName);
            jumper.value = String(page);
            if (status) status.textContent = teacherName ? `${notePrefix}: ${label} (Pg ${page})` : 'Select a teacher';

            // Always render only the selected page in-modal
            renderPage(page);
            configureOpenButton(page, label);
            return { page, label };
        };

        // Expose a small hook so other UI (Relief Pool / Absent list / Relief selection) can update the PDF target
        window.__setPdfTeacher = (name, day=null, slot=null) => {
            window.__pdfCurrentTeacher = String(name||'').trim();

            const res = syncToTeacher(name, 'Selected');
            // Store highlight request so the PDF canvas can draw it after render
            if (day && slot) {
                window.__pdfHighlight = { page: res.page, day: String(day||'').toUpperCase(), slot: String(slot||'') };
            }
            return res;
        };

        const configureOpenButton = (page, label) => {
            // Open a dedicated single-page view (this same app in a new tab)
            // This avoids native PDF viewers that show continuous pages.
            openBtn.onclick = () => {
                const u = new URL(window.location.href);
                u.searchParams.set('pdfPage', String(page || 1));
                if (label) u.searchParams.set('pdfTeacher', label);
                u.hash = 'pdf';
                window.open(u.toString(), '_blank');
            };
        };

        const openModal = () => {
            // iOS/Safari PDF rules:
            // - Do NOT try to navigate pages inside an iframe with #page (often fails)
            // - Use window.open for page navigation
            // - Keep iframe on base URL only (preview)

            const activeTeacher = findActiveTeacher();
            const { page, label } = syncToTeacher(activeTeacher, 'Auto');
            modal.classList.add('open');
        };

        const closeModal = () => {
            modal.classList.remove('open');
            if (status) status.textContent = '';
            if (renderStatus) renderStatus.textContent = '';
        };

        btn.onclick = () => {
            if (!modal.classList.contains('open')) openModal();
            else closeModal();
        };
        close.onclick = closeModal;
        modal.onclick = (e) => { if (e.target === modal) closeModal(); };

        jumper.onchange = (e) => {
            const page = Number(e.target.value || 1);
            configureOpenButton(page, jumper.options[jumper.selectedIndex]?.text || '');
            if (status) status.textContent = `Ready: Page ${page}`;
            renderPage(page);
        };

        // Default open button
        configureOpenButton(1, '');

        // Auto-open single-page view if this tab was opened via Open PDF
        try {
            const u = new URL(window.location.href);
            const qp = u.searchParams.get('pdfPage');
            if (qp) {
                const page = Number(qp || 1);
                const teacherLabel = u.searchParams.get('pdfTeacher') || '';
                jumper.value = String(page);
                if (status) status.textContent = teacherLabel ? `Opened: ${teacherLabel} (Pg ${page})` : `Opened: Pg ${page}`;
                modal.classList.add('open');
                renderPage(page);
            }
        } catch (_) {}
    }

    // --- RELIEF VIEW ---
    function setupReliefView(currentDayName, allSchedules, teacherData) {
        const container = document.getElementById('relief-results');
        const daySelect = document.getElementById('relief-day-select');
        const pool = document.getElementById('replacement-teacher-multiselect');
        const absentContainer = document.getElementById('absent-teacher-multiselect');
        const detailsContainer = document.getElementById('absent-details-container');

        // Populate Lists
        absentContainer.innerHTML = '';
        pool.innerHTML = '';
        daySelect.innerHTML = '';

        Object.keys(teacherData).sort().forEach(t => {
            const label = `<label><input type="checkbox" value="${t}" class="mr-1"><span>${t}</span></label>`;
            absentContainer.innerHTML += label;
            pool.innerHTML += label;
        });
        days.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d; opt.text = d;
            if(d === currentDayName) opt.selected = true;
            daySelect.appendChild(opt);
        });
        
        // NEW: HIGHLIGHT FUNCTION
        const updateDayHighlights = () => {
            const selectedAbsent = Array.from(absentContainer.querySelectorAll('input:checked')).map(i => i.value);
            const options = daySelect.querySelectorAll('option');
            
            // Reset styles
            options.forEach(opt => {
                opt.classList.remove('highlight-day-option');
                opt.text = opt.value; 
            });

            if (selectedAbsent.length === 0) return;

            days.forEach(day => {
                let classCount = 0;
                selectedAbsent.forEach(teacher => {
                    if (teacherData[teacher] && teacherData[teacher].schedule && teacherData[teacher].schedule[day]) {
                        const classes = teacherData[teacher].schedule[day];
                        if (classes.length > 0) {
                            classCount += classes.length;
                        }
                    }
                });

                if (classCount > 0) {
                    const opt = Array.from(options).find(o => o.value === day);
                    if (opt) {
                        opt.classList.add('highlight-day-option');
                        opt.text = `${day} (${classCount} Classes)`;
                    }
                }
            });
        };
        
        absentContainer.addEventListener('change', updateDayHighlights);

        // NEW: When you tick an absent teacher, sync PDF target to that teacher
        absentContainer.addEventListener('change', (e) => {
            const t = e?.target;
            if (t && t.matches && t.matches('input[type=checkbox]') && t.checked) {
                if (typeof window.__setPdfTeacher === 'function') window.__setPdfTeacher(t.value);
            }
        });

        // Filter Function
        const filterList = (id, text) => {
            document.querySelectorAll(`#${id} label`).forEach(l => {
                const name = l.querySelector('span').innerText.toLowerCase();
                l.style.display = name.includes(text.toLowerCase()) ? 'block' : 'none';
            });
        };
        document.getElementById('absent-search').oninput = (e) => filterList('absent-teacher-multiselect', e.target.value);
        document.getElementById('relief-search').oninput = (e) => filterList('replacement-teacher-multiselect', e.target.value);

        const currentSelections = new Map();
        const absentMeta = new Map(); // teacher -> {reason, notes}

        // Persist assignments + absent meta across re-renders
        const ASSIGN_STORE_KEY = 'relief_assignments_v1';
        const ABSENT_META_KEY  = 'absent_meta_v1';

        try {
            const savedA = JSON.parse(localStorage.getItem(ASSIGN_STORE_KEY) || '[]');
            if (Array.isArray(savedA)) savedA.forEach(([k,v]) => currentSelections.set(k,v));
        } catch (e) {}

        try {
            const savedM = JSON.parse(localStorage.getItem(ABSENT_META_KEY) || '{}');
            if (savedM && typeof savedM === 'object') {
                Object.keys(savedM).forEach(t => absentMeta.set(t, savedM[t] || {reason:'', notes:''}));
            }
        } catch (e) {}

        const saveAssignments = () => {
            try {
                localStorage.setItem(ASSIGN_STORE_KEY, JSON.stringify(Array.from(currentSelections.entries())));
            } catch (e) {}
        };

        const saveAbsentMeta = () => {
            try {
                const obj = {};
                absentMeta.forEach((v,k) => obj[k] = v);
                localStorage.setItem(ABSENT_META_KEY, JSON.stringify(obj));
            } catch (e) {}
        };
        
        const renderAbsentDetails = (absentList) => {
            detailsContainer.innerHTML = '';
            if (absentList.length === 0) {
                detailsContainer.classList.add('hidden');
                return;
            }
            detailsContainer.classList.remove('hidden');
            let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-3">';
            absentList.forEach(t => {
                html += `
                    <div class="bg-yellow-50 p-2 border border-yellow-200 rounded text-xs">
                        <div class="font-bold text-yellow-800 mb-1">${t}</div>
                        <div class="flex gap-2">
                            <select class="absent-reason w-1/3 border rounded p-1" data-teacher="${t}">
                                <option value="">Reason</option>
                                ${REASONS.map(r => `<option value="${r}">${r}</option>`).join('')}
                            </select>
                            <input type="text" class="absent-notes w-2/3 border rounded p-1" data-teacher="${t}" placeholder="Notes...">
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            detailsContainer.innerHTML = html;

            // Restore saved reason/notes and keep them persisted
            absentList.forEach(t => {
                const rs = detailsContainer.querySelector(`.absent-reason[data-teacher="${t}"]`);
                const ni = detailsContainer.querySelector(`.absent-notes[data-teacher="${t}"]`);
                const saved = absentMeta.get(t) || { reason: '', notes: '' };
                if (rs) rs.value = saved.reason || '';
                if (ni) ni.value = saved.notes || '';

                if (rs) rs.onchange = () => {
                    absentMeta.set(t, { reason: rs.value || '', notes: (ni ? (ni.value || '') : (saved.notes || '')) });
                    saveAbsentMeta();
                };
                if (ni) ni.oninput = () => {
                    absentMeta.set(t, { reason: (rs ? (rs.value || '') : (saved.reason || '')), notes: ni.value || '' });
                    saveAbsentMeta();
                };
            });
        };

        const render = () => {
            const absent = Array.from(absentContainer.querySelectorAll('input:checked')).map(i => i.value);
            const relief = Array.from(pool.querySelectorAll('input:checked')).map(i => i.value);
            const day = daySelect.value;
            
            container.innerHTML = '';
            if(absent.length === 0) return;

            const slots = [];
            absent.forEach(t => {
                (teacherData[t]?.schedule[day] || []).forEach(s => slots.push({...s, original: t}));
            });
            
            if(slots.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center text-gray-500 py-4">No classes for selected teachers today.</div>`;
                return;
            }

            slots.sort((a,b) => timeToMinutes(a.period.split('-')[0]) - timeToMinutes(b.period.split('-')[0]));

            slots.forEach((s, idx) => {
                const slotId = `${s.period}-${s.className}-${s.original}`;
                const card = document.createElement('div');
                card.className = "bg-white border rounded p-2 shadow-sm text-xs";
                
                const ranked = relief.map(r => {
                    if(absent.includes(r)) return null;
                    const score = calculateLoadScore(r, teacherData, day, s.period);
                    return { name: r, score };
                }).filter(Boolean).sort((a,b) => (a.score - b.score) || a.name.localeCompare(b.name));

                // Base options (will be refined by PDF authority)
                const previouslyAssigned = currentSelections.get(slotId) || '';
                let optionsHtml = `<option value="">-- Assign --</option>`;

                // Ensure an already-assigned teacher is never lost when pool list changes
                if (previouslyAssigned && !ranked.some(x => x.name === previouslyAssigned)) {
                    optionsHtml += `<option value="${previouslyAssigned}">${previouslyAssigned} (ASSIGNED)</option>`;
                }

                ranked.forEach(r => {
                    optionsHtml += `<option value="${r.name}">${r.name} (checking PDF...)</option>`;
                });

                if(ranked.length===0 && !previouslyAssigned) optionsHtml = `<option value="">No relief selected</option>`;

                card.innerHTML = `
                    <div class="flex justify-between mb-1">
                        <span class="bg-indigo-100 text-indigo-800 px-1 rounded font-bold">${s.period}</span>
                        <span class="font-bold text-gray-700">${s.className}</span>
                    </div>
                    <div class="mb-1 text-gray-600 truncate">${s.subject} <span class="text-red-500">(${s.original})</span></div>
                    <select class="relief-select w-full border rounded p-1" data-details='${JSON.stringify(s)}'>${optionsHtml}</select>
                `;
                
                const select = card.querySelector('select');

                // Restore previously assigned value BEFORE PDF re-ranking (critical for preserving selection)
                if (currentSelections.has(slotId)) select.value = currentSelections.get(slotId);

                // PDF-authoritative FREE/BUSY refinement (Option 1)
                if (window.__pdfAvail && typeof window.__pdfAvail.annotateSelect === 'function') {
                    window.__pdfAvail.annotateSelect(select, ranked, day, s.period).catch(() => {});
                }
                select.onchange = (e) => {
                    currentSelections.set(slotId, e.target.value);
                    saveAssignments();
                    // NEW: When you assign a relief teacher, sync PDF target to that teacher
                    if (e.target.value && typeof window.__setPdfTeacher === 'function') window.__setPdfTeacher(e.target.value, day, s.period);
                    updateConflicts();
                };
                container.appendChild(card);
            });
            
            document.getElementById('roster-generation-section').classList.remove('hidden');
            updateConflicts();
        };

        const updateConflicts = () => {
             const allSelects = document.querySelectorAll('.relief-select');

             const toMinutes = (t) => {
                 const m = String(t || '').trim().replace('.', ':').match(/(\d{1,2}):(\d{2})/);
                 if (!m) return null;
                 return (parseInt(m[1], 10) * 60) + parseInt(m[2], 10);
             };
             const rangeTo = (rng) => {
                 const parts = String(rng || '').trim().split('-');
                 if (parts.length < 2) return null;
                 const a = toMinutes(parts[0]);
                 const b = toMinutes(parts[1]);
                 if (a == null || b == null) return null;
                 return { start: a, end: b };
             };
             const overlaps = (a, b) => {
                 const ra = rangeTo(a);
                 const rb = rangeTo(b);
                 if (!ra || !rb) return false;
                 return ra.start < rb.end && rb.start < ra.end;
             };

             // Count overlapping usage per teacher per select
             allSelects.forEach(sel => {
                 const myVal = (sel.value || '').trim();
                 const myDet = JSON.parse(sel.dataset.details || '{}');
                 const myTime = myDet?.period || '';

                 // Red border if THIS selection conflicts with any other selection for the same teacher in overlapping time.
                 let hasOverlapConflict = false;
                 if (myVal && myTime) {
                     allSelects.forEach(other => {
                         if (other === sel) return;
                         const oVal = (other.value || '').trim();
                         if (!oVal || oVal !== myVal) return;
                         const oDet = JSON.parse(other.dataset.details || '{}');
                         const oTime = oDet?.period || '';
                         if (oTime && overlaps(oTime, myTime)) hasOverlapConflict = true;
                     });
                 }
                 if (hasOverlapConflict) sel.classList.add('border-red-500', 'bg-red-50');
                 else sel.classList.remove('border-red-500', 'bg-red-50');

                 // Option annotations: (Time Conflict) if picking that option would overlap with the teacher's other assignments
                 Array.from(sel.options).forEach(opt => {
                     const optName = (opt.value || '').trim();
                     if (!optName) return;

                     let isAssignedElsewhere = false;
                     let wouldOverlap = false;

                     allSelects.forEach(other => {
                         if (other === sel) return;
                         const oVal = (other.value || '').trim();
                         if (!oVal || oVal !== optName) return;
                         isAssignedElsewhere = true;
                         const oDet = JSON.parse(other.dataset.details || '{}');
                         const oTime = oDet?.period || '';
                         if (oTime && myTime && overlaps(oTime, myTime)) wouldOverlap = true;
                     });

                     opt.classList.remove('conflict-warning', 'time-conflict');
                     opt.text = opt.text.replace(' (Assigned)', '').replace(' (Time Conflict)', '');

                     if (wouldOverlap) {
                         opt.classList.add('time-conflict');
                         opt.text += ' (Time Conflict)';
                     } else if (isAssignedElsewhere) {
                         opt.classList.add('conflict-warning');
                         opt.text += ' (Assigned)';
                     }
                 });
             });
        };

        document.getElementById('find-relief-btn').onclick = () => {
            const absent = Array.from(absentContainer.querySelectorAll('input:checked')).map(i => i.value);
            renderAbsentDetails(absent);
            render();
        };
        pool.addEventListener('change', (e) => {
            const t = e?.target;
            if (t && t.matches && t.matches('input[type=checkbox]') && t.checked) {
                if (typeof window.__setPdfTeacher === 'function') window.__setPdfTeacher(t.value);
            }
            if (container.children.length > 0) render();
        }); 

        document.getElementById('generate-rosters-btn').onclick = () => {
            const roster = [];
            document.querySelectorAll('.relief-select').forEach(sel => {
                if(sel.value) {
                    const det = JSON.parse(sel.dataset.details);
                    const reasonSelect = document.querySelector(`.absent-reason[data-teacher="${det.original}"]`);
                    const notesInput = document.querySelector(`.absent-notes[data-teacher="${det.original}"]`);
                    const savedMeta = (typeof absentMeta !== 'undefined' && absentMeta.get) ? (absentMeta.get(det.original) || {reason:'', notes:''}) : {reason:'', notes:''};
                    roster.push({
                        time: det.period,
                        class: det.className,
                        subject: det.subject,
                        original: det.original,
                        relief: sel.value,
                        reason: reasonSelect ? reasonSelect.value : (savedMeta.reason || ''),
                        notes: notesInput ? notesInput.value : (savedMeta.notes || '')
                    });
                }
            });
            
            roster.sort((a,b) => timeToMinutes(a.time.split('-')[0]) - timeToMinutes(b.time.split('-')[0]));
            
            let html = `<div class="text-center mb-4"><h2 class="text-xl font-bold uppercase">Jadual Guru Ganti - ${daySelect.value}</h2><p class="text-sm">${document.getElementById('current-day-display').textContent}</p></div>
            <table class="w-full text-xs border border-collapse">
                <thead><tr class="bg-gray-200">
                    <th class="border border-black p-2 w-20">Masa</th>
                    <th class="border border-black p-2 w-16">Kelas</th>
                    <th class="border border-black p-2 w-16">Subjek</th>
                    <th class="border border-black p-2">Absent</th>
                    <th class="border border-black p-2 w-24">Reason</th>
                    <th class="border border-black p-2">Guru Ganti</th>
                    <th class="border border-black p-2 w-24">Tanda Tangan</th>
                </tr></thead><tbody>`;
            
            roster.forEach(r => {
                html += `<tr>
                    <td class="border border-black p-2 text-center font-mono">${r.time}</td>
                    <td class="border border-black p-2 text-center font-bold">${r.class}</td>
                    <td class="border border-black p-2 text-center">${r.subject}</td>
                    <td class="border border-black p-2">${r.original}</td>
                    <td class="border border-black p-2 text-center">${r.reason} ${r.notes ? `(${r.notes})` : ''}</td>
                    <td class="border border-black p-2 font-bold">${r.relief}</td>
                    <td class="border border-black p-2"></td>
                </tr>`;
            });
            html += `</tbody></table>
            <div class="mt-8 flex justify-between text-sm px-10">
                <div>Disediakan oleh:<br><br>..................................................</div>
                <div>Disahkan oleh:<br><br>..................................................</div>
            </div>
            <div class="no-print mt-6 text-center">
                <button onclick="window.print()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded shadow-lg">Print / Save PDF</button>
                <button onclick="location.reload()" class="ml-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded shadow-lg">Back</button>
            </div>`;
            document.getElementById('relief-rosters-display').innerHTML = html;
            document.getElementById('relief-view').firstElementChild.style.display = 'none';
            document.getElementById('relief-results').style.display = 'none';
            document.getElementById('roster-generation-section').style.display = 'none';
            document.getElementById('absent-details-container').style.display = 'none';
        };
    }

    // --- SMART CLASS VIEW ---
    function setupSmartClassView(currentDayName, allSchedules) {
        const groupContainer = document.getElementById('class-groups');
        const navContainer = document.getElementById('class-navigation');
        const schedulesContainer = document.getElementById('class-schedules-container');

        const groupedClasses = {};
        allSchedules.forEach(s => {
            const match = s.className.match(/^(\d+)/); 
            const groupKey = match ? `Form ${match[1]}` : "Others";
            if (!groupedClasses[groupKey]) groupedClasses[groupKey] = [];
            groupedClasses[groupKey].push(s);
        });

        groupContainer.innerHTML = '';
        Object.keys(groupedClasses).sort().forEach(group => {
            const btn = document.createElement('button');
            btn.textContent = group;
            btn.className = "px-3 py-1.5 bg-white border border-gray-300 rounded text-xs font-semibold hover:bg-indigo-50 shadow-sm transition-colors text-gray-700";
            btn.onclick = () => {
                Array.from(groupContainer.children).forEach(c => c.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600'));
                btn.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
                btn.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
                renderClassButtons(groupedClasses[group]);
            };
            groupContainer.appendChild(btn);
        });

        if (groupContainer.firstChild) groupContainer.firstChild.click();

        function renderClassButtons(classes) {
            navContainer.innerHTML = '';
            classes.sort((a,b) => a.className.localeCompare(b.className));
            
            classes.forEach((schedule, index) => {
                const btn = document.createElement('button');
                btn.textContent = schedule.className;
                btn.className = "class-nav-button px-3 py-1 text-xs border border-gray-300 rounded bg-white hover:bg-gray-100 text-gray-600";
                btn.onclick = () => {
                    Array.from(navContainer.children).forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    renderSmartTable(schedule, currentDayName);
                };
                navContainer.appendChild(btn);
                if (index === 0) btn.click();
            });
        }

        function renderSmartTable(schedule, currentDayName) {
            const filteredTimeSlots = schedule.timeSlots;
            const headerInfo = `<div class="mb-4 text-center"><h2 class="text-xl font-bold text-gray-800 tracking-tight">JADUAL KELAS ${schedule.className}</h2><div class="text-xs text-gray-500 font-mono mt-1">Guru Kelas: ${schedule.classTeacher || 'N/A'}</div></div>`;
            
            let tableHTML = `<div class="smart-table-container"><table class="smart-table"><thead class="text-xs uppercase text-gray-500 font-bold"><tr><th class="p-3 min-w-[80px] text-center border-r">HARI</th>${filteredTimeSlots.map(slot => `<th class="p-2 min-w-[100px] text-center border-r whitespace-nowrap">${slot.replace('-', '<br>')}</th>`).join('')}</tr></thead><tbody class="text-xs">`;

            days.forEach(day => {
                const isToday = day === currentDayName;
                const rowClass = isToday ? 'current-day-highlight' : (days.indexOf(day) % 2 === 0 ? 'bg-white' : 'bg-gray-50');
                tableHTML += `<tr class="${rowClass} hover:bg-gray-100 transition-colors"><td class="p-3 font-bold text-center border-b border-r text-gray-700">${day}</td>`;
                
                let renderedContent = new Array(filteredTimeSlots.length).fill(null);
                const daySchedule = schedule.scheduleData[day] || [];

                daySchedule.forEach(entry => {
                    const cleanEntryPeriod = cleanTimeSlot(entry.period);
                    let startIndex = -1;
                    for(let i = 0; i < filteredTimeSlots.length; i++) { if(cleanTimeSlot(filteredTimeSlots[i]) === cleanEntryPeriod) { startIndex = i; break; } }
                    if (startIndex > -1) {
                         const style = getSubjectStyle(entry.subject);
                         const content = `<div class="flex flex-col h-full justify-center" style="${style} padding: 6px; border-radius: 6px;"><div class="font-bold text-[11px] leading-tight mb-1">${entry.subject || '-'}</div><div class="text-[10px] opacity-80">${entry.teacher || ''}</div>${entry.location ? `<div class="text-[9px] mt-1 font-mono bg-white/50 inline-block px-1 rounded self-center">${entry.location}</div>` : ''}</div>`;
                         renderedContent[startIndex] = { content, colspan: 1 };
                    }
                });

                const rehatTime = cleanTimeSlot(schedule.rehatSlot);
                let rehatIndex = -1;
                for(let i=0; i<filteredTimeSlots.length; i++) { if(cleanTimeSlot(filteredTimeSlots[i]) === rehatTime) { rehatIndex = i; break; } }
                if (rehatIndex > -1) renderedContent[rehatIndex] = { content: `<div class="flex items-center justify-center h-full bg-yellow-100 text-yellow-800 font-bold tracking-widest writing-mode-vertical-rl text-[10px] rounded">REHAT</div>`, colspan: 1 };

                renderedContent.forEach((cell) => {
                    if (cell) tableHTML += `<td class="p-1 border-b border-r h-24 align-top" colspan="${cell.colspan}">${cell.content}</td>`;
                    else tableHTML += `<td class="p-1 border-b border-r empty-slot-pattern"></td>`;
                });
                tableHTML += `</tr>`;
            });
            schedulesContainer.innerHTML = headerInfo + tableHTML + `</tbody></table></div>`;
        }
    }

    // --- EDIT VIEW ---
    function setupEditView(allSchedules) {
        const classSelect = document.getElementById('edit-class-select');
        const daySelect = document.getElementById('edit-day-select');
        const editArea = document.getElementById('edit-area');
        const tableBody = document.getElementById('edit-table-body');
        const addBtn = document.getElementById('add-slot-btn');
        const modal = document.getElementById('edit-entry-modal');
        const saveEditBtn = document.getElementById('save-edit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const deleteBtn = document.getElementById('delete-slot-btn');
        const editStatus = document.getElementById('edit-status-msg');
        
        const allPeriods = new Set();
        const allTeachers = new Set();
        const allSubjects = new Set();
        const allLocations = new Set();
        
        allSchedules.forEach(s => {
            s.timeSlots.forEach(t => allPeriods.add(cleanTimeSlot(t)));
            days.forEach(d => {
                (s.scheduleData[d] || []).forEach(entry => {
                    if(entry.teacher) entry.teacher.split('/').forEach(t => allTeachers.add(normalizeTeacherName(t)));
                    if(entry.subject) allSubjects.add(entry.subject.trim().toUpperCase());
                    if(entry.location) allLocations.add(entry.location.trim().toUpperCase());
                });
            });
        });

        mergeMasterIntoSets(allTeachers, allSubjects, allLocations);

        classSelect.innerHTML = '<option value="">-- Select Class --</option>';
        allSchedules.sort((a,b) => a.className.localeCompare(b.className)).forEach(s => classSelect.innerHTML += `<option value="${s.className}">${s.className}</option>`);
        daySelect.innerHTML = '<option value="">-- Select Day --</option>';
        daySelect.innerHTML += `<option value="ALL_WEEK">ALL WEEK</option>`;
        days.forEach(d => daySelect.innerHTML += `<option value="${d}">${d}</option>`);
        daySelect.value = 'ALL_WEEK';
        
        const populateSelect = (id, items) => {
            const select = document.getElementById(id);
            select.innerHTML = '<option value="">-- Select --</option>';
            Array.from(items).sort().forEach(i => { if(i) select.innerHTML += `<option value="${i}">${i}</option>`; });
        };
        const sortedPeriods = Array.from(allPeriods).sort((a,b)=>timeToMinutes(a.split('-')[0])-timeToMinutes(b.split('-')[0]));
        populateSelect('edit-modal-period', sortedPeriods);
        populateSelect('edit-modal-teacher', allTeachers);
        populateSelect('edit-modal-subject', allSubjects);
        populateSelect('edit-modal-location', allLocations);

        let currentEditingClass = null;
        let currentEditingDay = null;
        let currentDayData = [];
        let editingIndex = -1;

        let currentWeekData = {};
        let editingDay = null;
        
        const isNA = (value) => {
            if (value === undefined || value === null) return true;
            const v = String(value).trim().toUpperCase();
            return v === '' || v === 'N/A' || v === 'NA' || v === '-' || v === 'UNKNOWN';
        };
        const rowHasNA = (slot) => {
            if (!slot) return true;
            return isNA(slot.subject) || isNA(slot.teacher) || isNA(slot.location);
        };
        
        const renderTable = () => {
            if(!currentEditingClass || !currentEditingDay) { editArea.classList.add('hidden'); return; }
            editArea.classList.remove('hidden');
            tableBody.innerHTML = '';

            const naOnlyEl = document.getElementById('filter-na-only');
            const showNAOnly = naOnlyEl ? naOnlyEl.checked : false;
            let naCounter = 0;
            let renderedAny = false;

            const renderOneRow = (slot, index, dayLabel) => {
                const hasNA = rowHasNA(slot);
                if (hasNA) naCounter++;
                if (showNAOnly && !hasNA) return false;

                const periodLabel = (currentEditingDay === 'ALL_WEEK') ? `${dayLabel} — ${slot.period || ''}` : (slot.period || '');
                const tr = document.createElement('tr');
                tr.className = `hover:bg-gray-50 border-b last:border-0 ${hasNA ? 'bg-yellow-100 border-l-4 border-yellow-500' : ''}`;
                tr.innerHTML = `
                    <td class="p-3 font-mono text-xs">${periodLabel}</td>
                    <td class="p-3 font-bold text-gray-700">${slot.subject || ''}</td>
                    <td class="p-3">${slot.teacher || ''}</td>
                    <td class="p-3 text-gray-500 text-xs">${slot.location || '-'}</td>
                    <td class="p-3 text-right">
                        <button class="edit-btn text-indigo-600 hover:text-indigo-800 font-bold text-xs mr-2" data-day="${dayLabel}" data-idx="${index}">Edit</button>
                        <button class="del-btn text-red-500 hover:text-red-700 font-bold text-xs" data-day="${dayLabel}" data-idx="${index}">Delete</button>
                    </td>
                `;
                tableBody.appendChild(tr);
                return true;
            };

            if (currentEditingDay === 'ALL_WEEK') {
                currentWeekData = {};
                days.forEach(d => { currentWeekData[d] = [...(currentEditingClass.scheduleData[d] || [])]; });

                days.forEach(dayName => {
                    const dayData = currentWeekData[dayName] || [];
                    dayData.sort((a,b) => timeToMinutes(cleanTimeSlot(a.period).split('-')[0]) - timeToMinutes(cleanTimeSlot(b.period).split('-')[0]));

                    let willRenderThisDay = !showNAOnly;
                    if (showNAOnly) willRenderThisDay = dayData.some(rowHasNA);
                    if (!willRenderThisDay) return;

                    const sep = document.createElement('tr');
                    sep.innerHTML = `<td colspan="5" class="p-2 bg-gray-50 text-gray-700 font-bold">${dayName}</td>`;
                    tableBody.appendChild(sep);

                    if (dayData.length === 0 && !showNAOnly) {
                        const empty = document.createElement('tr');
                        empty.innerHTML = `<td colspan="5" class="p-3 text-center text-gray-400 text-xs">No slots defined for ${dayName}.</td>`;
                        tableBody.appendChild(empty);
                        return;
                    }

                    dayData.forEach((slot, idx) => {
                        const didRender = renderOneRow(slot, idx, dayName);
                        if (didRender) renderedAny = true;
                    });
                });
            } else {
                currentDayData.sort((a,b) => timeToMinutes(cleanTimeSlot(a.period).split('-')[0]) - timeToMinutes(cleanTimeSlot(b.period).split('-')[0]));
                if(currentDayData.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">No slots defined for this day.</td></tr>';
                } else {
                    currentDayData.forEach((slot, index) => {
                        const didRender = renderOneRow(slot, index, currentEditingDay);
                        if (didRender) renderedAny = true;
                    });
                }
            }

            const naCountEl = document.getElementById('na-count');
            if (naCountEl) naCountEl.textContent = naCounter > 0 ? `N/A found: ${naCounter}` : 'No N/A detected';
            if (showNAOnly && !renderedAny) tableBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">No N/A entries found for the selected scope.</td></tr>';
            
            document.querySelectorAll('.edit-btn').forEach(b => b.onclick = (e) => openModal(e.target.dataset.day, parseInt(e.target.dataset.idx)));
            document.querySelectorAll('.del-btn').forEach(b => b.onclick = (e) => deleteSlot(e.target.dataset.day, parseInt(e.target.dataset.idx)));
        };

        const loadData = () => {
            const cName = classSelect.value;
            const dName = daySelect.value;
            if(cName && dName) {
                currentEditingClass = allSchedules.find(s => s.className === cName);
                currentEditingDay = dName;
                if (dName === 'ALL_WEEK') {
                    currentWeekData = {};
                    days.forEach(d => { currentWeekData[d] = [...(currentEditingClass.scheduleData[d] || [])]; });
                    currentDayData = [];
                } else {
                    currentDayData = [...(currentEditingClass.scheduleData[dName] || [])];
                }
                renderTable();
            } else {
                editArea.classList.add('hidden');
            }
        };

        classSelect.onchange = loadData;
        daySelect.onchange = loadData;

        const findNaBtn = document.getElementById('find-na-btn');
        const filterNaOnly = document.getElementById('filter-na-only');
        if (findNaBtn) findNaBtn.onclick = () => { if (filterNaOnly) filterNaOnly.checked = false; renderTable(); };
        if (filterNaOnly) filterNaOnly.onchange = () => renderTable();

        const safeSet = (id, value) => {
            const select = document.getElementById(id);
            if (!value) { select.value = ""; return; }
            if (!Array.from(select.options).some(o => o.value === value)) {
                const opt = document.createElement('option'); opt.value = value; opt.text = value + " (Custom)"; select.add(opt);
            }
            select.value = value;
        };

        const openModal = (dayName, index) => {
            editingDay = dayName || currentEditingDay;
            editingIndex = index;
            const sourceArray = (currentEditingDay === 'ALL_WEEK') ? (currentWeekData[editingDay] || []) : currentDayData;

            if(index >= 0) {
                const d = sourceArray[index];
                safeSet('edit-modal-period', d.period);
                safeSet('edit-modal-subject', d.subject);
                safeSet('edit-modal-teacher', d.teacher);
                safeSet('edit-modal-location', d.location);
                deleteBtn.style.display = 'block';
            } else {
                safeSet('edit-modal-period', '');
                safeSet('edit-modal-subject', '');
                safeSet('edit-modal-teacher', '');
                safeSet('edit-modal-location', '');
                deleteBtn.style.display = 'none';
            }
            editStatus.textContent = '';
            modal.classList.add('open');
        };

        addBtn.onclick = () => {
            const targetDay = (currentEditingDay === 'ALL_WEEK') ? (editingDay || 'ISNIN') : currentEditingDay;
            openModal(targetDay, -1);
        };
        cancelEditBtn.onclick = () => modal.classList.remove('open');
        
        saveEditBtn.onclick = async () => {
            const p = document.getElementById('edit-modal-period').value;
            const s = document.getElementById('edit-modal-subject').value;
            const t = document.getElementById('edit-modal-teacher').value;
            const l = document.getElementById('edit-modal-location').value;

            if(!p || !s) return alert("Period and Subject required!");

            const newSlot = { period: cleanTimeSlot(p), subject: s, teacher: t, location: l };
            const dayToSave = (currentEditingDay === 'ALL_WEEK') ? (editingDay || 'ISNIN') : currentEditingDay;

            let targetArray;
            if (currentEditingDay === 'ALL_WEEK') {
                if (!currentWeekData[dayToSave]) currentWeekData[dayToSave] = [];
                targetArray = currentWeekData[dayToSave];
            } else {
                targetArray = currentDayData;
            }

            if(editingIndex >= 0) targetArray[editingIndex] = newSlot;
            else targetArray.push(newSlot);

            editStatus.textContent = "Saving...";
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, currentEditingClass.className);
                const updatePayload = {};
                updatePayload[`scheduleData.${dayToSave}`] = targetArray;
                await updateDoc(docRef, updatePayload);

                currentEditingClass.scheduleData[dayToSave] = targetArray;
                modal.classList.remove('open');
                if (currentEditingDay !== 'ALL_WEEK') currentDayData = [...targetArray];
                renderTable();
            } catch(e) {
                editStatus.innerHTML = `<span class="text-red-500">Error: ${e.message}</span>`;
            }
        };

        deleteBtn.onclick = () => deleteSlot((currentEditingDay === 'ALL_WEEK') ? (editingDay || 'ISNIN') : currentEditingDay, editingIndex);
        
        const deleteSlot = async (dayName, index) => {
            const dayToDelete = (currentEditingDay === 'ALL_WEEK') ? (dayName || 'ISNIN') : currentEditingDay;
            if(index < 0 || !confirm("Delete?")) return;

            let targetArray;
            if (currentEditingDay === 'ALL_WEEK') {
                targetArray = [...(currentEditingClass.scheduleData[dayToDelete] || [])];
            } else {
                targetArray = [...currentDayData];
            }
            targetArray.splice(index, 1);
            editStatus.textContent = "Deleting...";
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, currentEditingClass.className);
                const updatePayload = {};
                updatePayload[`scheduleData.${dayToDelete}`] = targetArray;
                await updateDoc(docRef, updatePayload);

                currentEditingClass.scheduleData[dayToDelete] = targetArray;
                modal.classList.remove('open');
                if (currentEditingDay !== 'ALL_WEEK') currentDayData = [...targetArray];
                renderTable();
            } catch(e) {
                alert(e.message);
            }
        };
    }

    // --- OTHER VIEWS ---
    function setupTeacherView(currentDayName, allSchedules, teacherData) {
        const select = document.getElementById('teacher-select');
        const display = document.getElementById('teacher-schedule-display');
        Object.keys(teacherData).sort().forEach(t => { const opt = document.createElement('option'); opt.value = t; opt.text = t; select.appendChild(opt); });
        select.onchange = (e) => {
            const t = e.target.value;
            if(!t || t.includes("Select")) { display.innerHTML = ''; return; }
            const schedule = teacherData[t].schedule;
            let html = `<div class="grid grid-cols-1 md:grid-cols-5 gap-4 mt-4">`;
            days.forEach(d => {
                const daily = schedule[d] || [];
                daily.sort((a,b) => timeToMinutes(a.period.split('-')[0]) - timeToMinutes(b.period.split('-')[0]));
                html += `<div class="bg-white border rounded-lg p-3 ${d===currentDayName ? 'border-indigo-500 ring-1 ring-indigo-500' : 'border-gray-200'}"><h4 class="font-bold text-sm mb-2 border-b pb-1 text-center">${d}</h4>${daily.length === 0 ? '<p class="text-xs text-gray-400 text-center">Free</p>' : daily.map(s => `<div class="mb-2 p-2 bg-gray-50 rounded text-xs border border-gray-100"><span class="font-bold text-indigo-700 block">${s.period}</span><span>${s.className} - ${s.subject}</span></div>`).join('')}</div>`;
            });
            display.innerHTML = html + `</div>`;
        };
    }

    function setupGroupAvailabilityView(currentDay, allSchedules, teacherData) {
        const daySelect = document.getElementById('day-select-group');
        days.forEach(d => { const opt = document.createElement('option'); opt.value = d; opt.text = d; if(d === currentDay) opt.selected = true; daySelect.appendChild(opt); });
        const multiSelectContainer = document.getElementById('teacher-multi-select');
        Object.keys(teacherData).sort().forEach(t => { const label = document.createElement('label'); label.innerHTML = `<input type="checkbox" value="${t}" class="mr-2"><span>${t}</span>`; multiSelectContainer.appendChild(label); });
        document.getElementById('find-common-slots-btn').onclick = () => {
             const selected = Array.from(document.querySelectorAll('#teacher-multi-select input:checked')).map(i => i.value);
             const day = daySelect.value;
             const res = document.getElementById('common-slots-results');
             if(selected.length===0) return res.innerHTML = "Select teachers.";
             const periods = ["7:30-8:00", "8:00-8:30", "8:30-9:00", "9:00-9:30", "9:30-10:00", "10:30-11:00", "11:00-11:30", "11:30-12:00", "12:00-12:30", "12:30-1:00", "1:00-1:30", "1:30-2:00"];
             let html = '<div class="space-y-2 mt-4">';
             periods.forEach(p => {
                 const busy = [];
                 selected.forEach(t => { if(findCoveringPeriod(p, teacherData[t]?.schedule[day] || [])) busy.push(t); });
                 if(busy.length === 0) html += `<div class="p-2 bg-green-100 rounded text-sm flex justify-between"><b>${p}</b><span>Available</span></div>`;
                 else html += `<div class="p-2 bg-red-50 rounded text-sm flex justify-between"><b>${p}</b><span class="text-red-500 text-xs">Busy: ${busy.join(', ')}</span></div>`;
             });
             res.innerHTML = html + '</div>';
        }
    }

    // --- UPLOAD & SETTINGS ---
    function setupSettingsModal(allSchedules) {
        const modal = document.getElementById('settings-modal');
        const btn = document.getElementById('settings-btn');
        const close = document.getElementById('close-modal-btn');
        
        const teachers = new Set();
        const subjects = new Set();
        const locations = new Set();

        allSchedules.forEach(s => {
            days.forEach(d => {
                if(s.scheduleData[d]) {
                    s.scheduleData[d].forEach(entry => {
                        if(entry.teacher) entry.teacher.split('/').forEach(t => { const norm = normalizeTeacherName(t); if(isValidTeacher(norm)) teachers.add(norm); });
                        if(entry.subject) subjects.add(entry.subject.trim());
                        if(entry.location) locations.add(entry.location.trim());
                    });
                }
            });
        });

        mergeMasterIntoSets(teachers, subjects, locations);
        const sortedTeachers = Array.from(teachers).sort();
        const sortedSubjects = Array.from(subjects).sort();
        const sortedLocations = Array.from(locations).sort();

        document.getElementById('count-teachers').textContent = sortedTeachers.length;
        document.getElementById('list-teachers').value = sortedTeachers.join('\n');
        document.getElementById('count-subjects').textContent = sortedSubjects.length;
        document.getElementById('list-subjects').value = sortedSubjects.join('\n');
        document.getElementById('count-locations').textContent = sortedLocations.length;
        document.getElementById('list-locations').value = sortedLocations.join('\n');

        // NEW: BULK EDIT LOGIC
        const bulkType = document.getElementById('bulk-type-select');
        const bulkContainer = document.getElementById('bulk-checkbox-container');
        const bulkSearch = document.getElementById('bulk-list-search');
        const bulkNew = document.getElementById('bulk-new-value');
        const bulkBtn = document.getElementById('bulk-update-btn');
        const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
        const bulkStatus = document.getElementById('bulk-status');

        // NEW: MASTER DATA
        const masterType = document.getElementById('master-type-select');
        const masterVal = document.getElementById('master-new-value');
        const masterAddBtn = document.getElementById('master-add-btn');
        const masterRemoveBtn = document.getElementById('master-remove-btn');
        const masterStatus = document.getElementById('master-status');

        const refreshSummaryAndBulkUI = () => {
            const sortedTeachers = Array.from(teachers).sort();
            const sortedSubjects = Array.from(subjects).sort();
            const sortedLocations = Array.from(locations).sort();

            document.getElementById('count-teachers').textContent = sortedTeachers.length;
            document.getElementById('list-teachers').value = sortedTeachers.join('\n');
            document.getElementById('count-subjects').textContent = sortedSubjects.length;
            document.getElementById('list-subjects').value = sortedSubjects.join('\n');
            document.getElementById('count-locations').textContent = sortedLocations.length;
            document.getElementById('list-locations').value = sortedLocations.join('\n');

            window.__bulkSortedTeachers = sortedTeachers;
            window.__bulkSortedSubjects = sortedSubjects;
            window.__bulkSortedLocations = sortedLocations;
        };
        refreshSummaryAndBulkUI();

        const populateBulkList = () => {
             const type = bulkType.value;
             let items = [];
             if(type === 'teacher') items = (window.__bulkSortedTeachers || sortedTeachers);
             else if(type === 'subject') items = (window.__bulkSortedSubjects || sortedSubjects);
             else if(type === 'location') items = (window.__bulkSortedLocations || sortedLocations);

             bulkContainer.innerHTML = '';
             items.forEach(i => {
                 const div = document.createElement('div');
                 div.className = 'flex items-center';
                 div.innerHTML = `<label class="flex items-center cursor-pointer hover:bg-yellow-50 w-full p-1 rounded"><input type="checkbox" value="${i}" class="mr-2 form-checkbox h-3 w-3 text-yellow-600"><span class="truncate">${i}</span></label>`;
                 bulkContainer.appendChild(div);
             });
        };
        
        bulkType.onchange = populateBulkList;
        populateBulkList();

        window.__bulkSortedTeachers = sortedTeachers;
        window.__bulkSortedSubjects = sortedSubjects;
        window.__bulkSortedLocations = sortedLocations;

        const setMasterMsg = (msg, ok=true) => {
            masterStatus.textContent = msg;
            masterStatus.className = ok ? "text-xs mt-2 font-mono text-center text-emerald-700 h-4" : "text-xs mt-2 font-mono text-center text-red-700 h-4";
            setTimeout(()=>{ masterStatus.textContent = ""; }, 2500);
        };

        masterAddBtn.onclick = async () => {
            const type = masterType.value;
            const val = masterVal.value;
            const res = addToMaster(type, val);
            if(!res.ok) return setMasterMsg(res.msg, false);
            await saveMasterLists();

            const normalized = normalizeMasterValue(type, val);
            if(type === 'teacher') teachers.add(normalized);
            else if(type === 'subject') subjects.add(normalized);
            else locations.add(normalized);

            refreshSummaryAndBulkUI();
            populateBulkList();
            setMasterMsg("Added to master list.");
        };

        masterRemoveBtn.onclick = async () => {
            const type = masterType.value;
            const val = masterVal.value;
            const res = removeFromMaster(type, val);
            if(!res.ok) return setMasterMsg(res.msg, false);
            await saveMasterLists();

            const normalized = normalizeMasterValue(type, val);
            if(type === 'teacher') teachers.delete(normalized);
            else if(type === 'subject') subjects.delete(normalized);
            else locations.delete(normalized);

            refreshSummaryAndBulkUI();
            populateBulkList();
            setMasterMsg("Removed from master list.");
        };

        bulkSearch.oninput = (e) => {
            const term = e.target.value.toLowerCase();
            const labels = bulkContainer.querySelectorAll('label');
            labels.forEach(l => {
                const text = l.querySelector('span').innerText.toLowerCase();
                l.parentElement.style.display = text.includes(term) ? 'flex' : 'none';
            });
        };

        const performBulkUpdate = async (isDelete) => {
            const type = bulkType.value;
            const checkedBoxes = Array.from(bulkContainer.querySelectorAll('input:checked'));
            const selectedValues = checkedBoxes.map(cb => cb.value);
            
            if(selectedValues.length === 0) return alert("Please select at least one item from the list.");
            const newValue = isDelete ? "" : bulkNew.value.trim().toUpperCase();
            if(!isDelete && !newValue) return alert("Please enter a new value to replace the selected items.");
            
            const fieldName = type.toUpperCase();
            const actionMsg = isDelete ? `DELETE ${selectedValues.length} items from the ${fieldName} field` : `REPLACE ${selectedValues.length} items with "${newValue}" in the ${fieldName} field`;
            
            if(!confirm(`Are you sure you want to ${actionMsg}? This will update ALL schedules and cannot be undone.`)) return;

            bulkStatus.textContent = "Processing... do not close.";
            const batch = writeBatch(db);
            let updateCount = 0;

            allSchedules.forEach(schedule => {
                let modified = false;
                const newScheduleData = JSON.parse(JSON.stringify(schedule.scheduleData)); 
                days.forEach(day => {
                    if(newScheduleData[day]) {
                        newScheduleData[day].forEach(entry => {
                            if(type === 'teacher' && entry.teacher) {
                                const parts = entry.teacher.split('/');
                                if (isDelete) {
                                    const newParts = parts.filter(p => !selectedValues.includes(normalizeTeacherName(p)));
                                    if (newParts.length !== parts.length) { entry.teacher = newParts.join(' / '); modified = true; }
                                } else {
                                    const newParts = parts.map(p => {
                                        if(selectedValues.includes(normalizeTeacherName(p))) { modified = true; return newValue; }
                                        return p;
                                    });
                                    const uniqueParts = [...new Set(newParts)];
                                    entry.teacher = uniqueParts.join(' / ');
                                }
                            } 
                            else if(type === 'subject' && entry.subject && selectedValues.includes(entry.subject.trim())) { entry.subject = newValue; modified = true; }
                            else if(type === 'location' && entry.location && selectedValues.includes(entry.location.trim())) { entry.location = newValue; modified = true; }
                        });
                    }
                });

                if(modified) {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, schedule.className);
                    batch.update(docRef, { scheduleData: newScheduleData });
                    updateCount++;
                }
            });

            if(updateCount > 0) {
                try {
                    await batch.commit();
                    bulkStatus.textContent = `Success! Updated ${updateCount} classes. Reloading...`;
                    setTimeout(() => location.reload(), 1500);
                } catch(e) {
                    bulkStatus.textContent = "Error: " + e.message;
                }
            } else {
                bulkStatus.textContent = "No matching data found in schedules.";
            }
        };

        bulkBtn.onclick = () => performBulkUpdate(false);
        bulkDeleteBtn.onclick = () => performBulkUpdate(true);

        const openSettings = (e) => { try { e && e.preventDefault && e.preventDefault(); } catch(_) {} modal.classList.add('open'); };
        btn.addEventListener('click', openSettings);
        btn.addEventListener('touchend', openSettings, { passive: false });
        btn.addEventListener('pointerup', openSettings);
        const closeSettings = (e) => { try { e && e.preventDefault && e.preventDefault(); } catch(_) {} modal.classList.remove('open'); };
        close.addEventListener('click', closeSettings);
        close.addEventListener('touchend', closeSettings, { passive: false });
        close.addEventListener('pointerup', closeSettings);
        modal.onclick = (e) => { if(e.target === modal) modal.classList.remove('open'); }
        
        document.getElementById('upload-direct-btn').onclick = async () => {
            const file = document.getElementById('direct-json-upload').files[0];
            if(!file) return alert("Select file");
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    document.getElementById('upload-status').textContent = "Uploading...";
                    const batch = writeBatch(db);
                    data.slice(0, 400).forEach(c => {
                         c.timeSlots = (c.timeSlots||[]).map(cleanTimeSlot);
                         batch.set(doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, c.className), c);
                    });
                    await batch.commit();
                    location.reload();
                } catch(err) { alert(err.message); }
            };
            reader.readAsText(file);
        };
    }

    function setupViewToggler() {
        const buttons = document.querySelectorAll('.view-toggle-button');
        const views = document.querySelectorAll('.view-container');
        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                buttons.forEach(b => b.classList.remove('active'));
                views.forEach(v => v.classList.remove('active'));
                btn.classList.add('active');
                const targetId = btn.id.replace('view-', '').replace('-btn', '') + '-view';
                document.getElementById(targetId).classList.add('active');
            });
        });
    }

    const initAuth = async () => {
      updateStatus('connecting', 'Authenticating...');
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
      else await signInAnonymously(auth);
    };
    initAuth();
    
    onAuthStateChanged(auth, async (user) => {
        if(user) {
            updateStatus('connecting', 'Connected. Loading Data...');
            try {
                const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME));
                const data = []; snap.forEach(d => data.push(d.data()));
                await loadMasterLists();
                initializeUI(data);
            } catch (error) {
                console.error(error);
                updateStatus('error', 'Connection Failed. Check internet/permissions.');
            }
        } else {
             updateStatus('error', 'Auth Failed.');
        }
    });
</script>
</body>
</html>


